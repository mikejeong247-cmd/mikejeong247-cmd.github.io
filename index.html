<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>í”„ë¡œ ì´ëª¨ì§€ ê²€ìƒ‰ â€” ì¹´í…Œê³ ë¦¬ ëª¨ë“œ</title>
  <meta name="description" content="ì¹´í…Œê³ ë¦¬ ê¸°ë°˜ ì´ˆê³ ì† ì´ëª¨ì§€ ê²€ìƒ‰/ë³µì‚¬" />

  <style>
    :root{
      --grid-width: 520px;     /* ì´ˆê¸° LCP ìµœì†Œí™” */
      --tile-size: 72px;
      --gap: 8px;

      --cat-table-maxw: 1100px;
      --cat-cell-h: 48px;
      --cat-font: 15px;
    }
    *{ box-sizing: border-box; }
    html, body{ margin:0; padding:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple Color Emoji,Noto Color Emoji,sans-serif; }

    /* ìƒë‹¨: ê²€ìƒ‰ + ë³µì‚¬ */
    #toolbar{
      position: sticky; top: 0; z-index: 9;
      background:#fff; border-bottom:1px solid #eee; backdrop-filter: blur(4px);
    }
    #toolbar .inner{
      max-width: var(--cat-table-maxw); margin:0 auto; padding:10px 12px;
      display:grid; gap:8px; grid-template-columns: 1fr auto; align-items:center;
    }
    #search{
      width:100%; height:40px; border:1px solid #ddd; border-radius:8px; padding:0 12px; font-size:15px;
    }
    #copyBox{ display:flex; gap:8px; align-items:center; }
    #copyOut{ width:160px; height:40px; border:1px solid #ddd; border-radius:8px; padding:0 12px; font-size:16px; }
    #btnCopy{ height:40px; padding:0 14px; border:1px solid #333; background:#111; color:#fff; border-radius:8px; cursor:pointer; }

    /* ì¹´í…Œê³ ë¦¬ í‘œ */
    #catTableWrap{ position: sticky; top: 60px; z-index: 8; background:#fff; border-bottom:1px solid #eee; }
    #catTableWrap .inner{ max-width: var(--cat-table-maxw); margin:0 auto; padding:8px 12px; }
    table.cat-table{ width:100%; table-layout:fixed; border-collapse:collapse; font-size:var(--cat-font); }
    table.cat-table td{ padding:0; border:1px solid #f1f1f1; }
    .cat-btn{
      width:100%; height:var(--cat-cell-h); display:grid; grid-template-columns:28px 1fr;
      align-items:center; gap:8px; padding:8px 10px; border:0; background:#fff; cursor:pointer;
    }
    .cat-btn:hover{ background:#fafafa; }
    .cat-btn.active{ outline:2px solid rgba(0,0,0,.08); background:#f9f9ff; }
    .cat-emoji{ width:24px; height:24px; display:inline-flex; align-items:center; justify-content:center; font-size:20px; line-height:1; }
    .cat-label{ overflow:hidden; white-space:nowrap; text-overflow:ellipsis; text-align:left; }

    /* ê·¸ë¦¬ë“œ */
    #gridWrap{ max-width:var(--grid-width); margin:12px auto 60px; padding:0 8px; }
    #grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(var(--tile-size), 1fr));
      gap:var(--gap); align-items:start;
    }
    .tile{
      width:var(--tile-size); height:var(--tile-size);
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:10px; border:1px solid #eee; background:#fff;
      cursor:pointer; user-select:none; transition:transform .04s ease;
    }
    .tile:hover{ transform:translateY(-1px); background:#fafafa; }
    .tile img{ width:var(--tile-size); height:var(--tile-size); image-rendering:-webkit-optimize-contrast; }

    /* í† ìŠ¤íŠ¸ / ìƒíƒœ */
    #toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%); z-index:20;
      background:rgba(0,0,0,.8); color:#fff; padding:8px 12px; border-radius:20px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .2s ease;
    }
    #toast.show{ opacity:1; }
    #status{ max-width:720px; margin:20px auto; padding:12px; color:#444; text-align:center; display:none; }

    @media (max-width: 720px){
      :root{ --cat-font:14px; }
      #toolbar .inner{ grid-template-columns: 1fr; }
      #catTableWrap{ top:112px; }
    }
  </style>

  <!-- Twemoji (PNG ê°•ì œ, SVG OFF) -->
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <!-- ìƒë‹¨: ê²€ìƒ‰ + ë³µì‚¬ -->
  <header id="toolbar">
    <div class="inner">
      <input id="search" type="search" placeholder="ì´ëª¨ì§€ ì´ë¦„/í‚¤ì›Œë“œ ê²€ìƒ‰ (í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë‚´)" />
      <div id="copyBox">
        <input id="copyOut" type="text" readonly placeholder="ë³µì‚¬í•  ì´ëª¨ì§€" />
        <button id="btnCopy" type="button">ë³µì‚¬</button>
      </div>
    </div>
  </header>

  <!-- ì¹´í…Œê³ ë¦¬ í‘œ -->
  <section id="catTableWrap">
    <div class="inner">
      <table class="cat-table" id="catTable"><tbody id="catTbody"></tbody></table>
    </div>
  </section>

  <!-- ìƒíƒœ/ê·¸ë¦¬ë“œ/í† ìŠ¤íŠ¸ -->
  <div id="status"></div>
  <main id="gridWrap"><section id="grid"></section></main>
  <div id="toast">ë³µì‚¬ ì™„ë£Œ!</div>

  <!-- ì•± ìŠ¤í¬ë¦½íŠ¸ -->
  <script type="module">
    /* ========= 0) ì „ì—­/ìœ í‹¸ (í•„ìš”í•œ ê²ƒë§Œ) ========= */
    const UI = {
      search:   document.getElementById('search'),
      copyOut:  document.getElementById('copyOut'),
      btnCopy:  document.getElementById('btnCopy'),
      status:   document.getElementById('status'),
      grid:     document.getElementById('grid'),
      catTbody: document.getElementById('catTbody'),
      toast:    document.getElementById('toast'),
    };

    // ì²« ì¸ìƒ: 180ê°œ ì¦‰ì‹œ í˜ì¸íŠ¸(ëŠë¦¬ë©´ 120ìœ¼ë¡œ ì¤„ì´ì„¸ìš”)
    const FIRST_CHUNK = 180;
    const NEXT_CHUNK  = 180;

    let BUILD = null;
    let SPRITE_MAP = null;
    let SUPPORT_HINTS = null;

    let CAT_MAP = null;     // Map<cat, items[]>
    let ACTIVE_CAT = null;
    let BASE_LIST = [];
    let VIEW_LIST = [];
    let SPRITES_BASE = '';  // ìŠ¤í”„ë¼ì´íŠ¸ íŒŒì¼ ê¸°ë³¸ ê²½ë¡œ

    const koLabelMap = {
      "Smileys & Emotion":"ìŠ¤ë§ˆì¼/ê°ì •","People & Body":"í”¼í”Œ/ë°”ë””","Animals & Nature":"ë™ë¬¼/ìì—°",
      "Food & Drink":"ìŒì‹/ìŒë£Œ","Travel & Places":"ì—¬í–‰/ì¥ì†Œ","Activities":"í™œë™",
      "Objects":"ì‚¬ë¬¼","Symbols":"ê¸°í˜¸","Flags":"êµ­ê¸°"
    };
    const pickLabel = (raw) => koLabelMap[raw] || raw || "ê¸°íƒ€";

    const ensureTwemoji = (el) => window.twemoji?.parse(el, {
      base: "https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/", folder: "72x72", ext: ".png"
    });

    function showStatus(msg){ UI.status.style.display='block'; UI.status.textContent=msg; }
    function hideStatus(){ UI.status.style.display='none'; UI.status.textContent=''; }
    function showToast(text="ë³µì‚¬ ì™„ë£Œ!"){ UI.toast.textContent=text; UI.toast.classList.add('show'); setTimeout(()=>UI.toast.classList.remove('show'),900); }

    // ê²½ë¡œ ê³„ì‚°(ìœ ì €/í”„ë¡œì íŠ¸ í˜ì´ì§€ ìë™ ì¸ì‹)
    function pathBase(){
      const parts = location.pathname.split('/').filter(Boolean);
      return parts.length ? `/${parts[0]}/` : '/';
    }
    // ì•ˆì „ fetch (ë‹¨ìˆœ í›„ë³´ë§Œ)
    async function getJSON(paths){
      for(const p of paths){
        try{ const r = await fetch(p, {cache:"no-cache"}); if(r.ok){ const j=await r.json(); j.__src=p; return j; } }catch(_){}
      }
      return null;
    }

    /* ========= 1) ë°ì´í„° ë¡œë“œ ========= */
    async function loadData(){
      const base = pathBase();
      // ë¡œì»¬ ìš°ì„ (ê°™ì€ ë„ë©”ì¸) â†’ jsDelivr ë°±ì—…
      const hostUser = location.hostname.replace('.github.io','');
      const repo     = base === '/' ? `${hostUser}.github.io` : base.replace(/\//g,'');
      const cdn      = `https://cdn.jsdelivr.net/gh/${hostUser}/${repo}@main/`;

      BUILD = await getJSON([ `${base}data/build.json`, `/data/build.json`, `${cdn}data/build.json` ]);
      SPRITE_MAP = await getJSON([ `${base}sprites/SPRITE_MAP.json`, `/sprites/SPRITE_MAP.json`, `${cdn}sprites/SPRITE_MAP.json` ]);
      SUPPORT_HINTS = await getJSON([ `${base}sprites/SUPPORT_HINTS.json`, `/sprites/SUPPORT_HINTS.json`, `${cdn}sprites/SUPPORT_HINTS.json` ]);

      // ìŠ¤í”„ë¼ì´íŠ¸ ê¸°ë³¸ ê²½ë¡œ
      if (SPRITE_MAP?.__src) SPRITES_BASE = SPRITE_MAP.__src.replace(/SPRITE_MAP\.json.*$/,'');
      else SPRITES_BASE = `${base}sprites/`;

      if(!BUILD){
        showStatus("build.jsonì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Actions ì‹¤í–‰ ë˜ëŠ” /data/build.json ì¡´ì¬ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
        return false;
      }
      hideStatus();
      return true;
    }

    /* ========= 2) ë°ì´í„° ì •ê·œí™” (ì¤‘ìš” í¬ì¸íŠ¸) =========
       - buildê°€ "ê·¸ë£¹ ê°ì²´ { group: '...', items: [...] }" í˜•íƒœì—¬ë„
         ë‚´ë¶€ itemsë¥¼ ëª¨ë‘ í‰íƒ„í™”í•´ì„œ ë°˜í™˜í•œë‹¤. */
    function toArray(x){ return Array.isArray(x) ? x : (x ? [x] : []); }

    function codeToEmoji(code){ try{ return String.fromCodePoint(...String(code).split('-').map(h=>parseInt(h,16))); }catch(_){ return "â“"; } }

    function pick(obj, keys){
      for(const k of keys){
        if (obj[k] != null && obj[k] !== '') return obj[k];
        const k2 = Object.keys(obj).find(x=>x.toLowerCase()===k.toLowerCase());
        if(k2 && obj[k2]!=null && obj[k2]!=='') return obj[k2];
      }
      return '';
    }

    function normalizeItems(root){
      const out = [];
      const seen = new Set();

      function walk(node, inheritedCat=''){
        if(!node) return;
        if(Array.isArray(node)){
          for(const v of node) walk(v, inheritedCat);
          return;
        }
        if(typeof node !== 'object') return;

        // ê·¸ë£¹ ê°ì²´ë¼ë©´ ë‚´ë¶€ itemsë¥¼ ê±·ëŠ”ë‹¤
        const groupCat = pick(node, ['group','category','major','cat','section','type']) || inheritedCat;
        if (Array.isArray(node.items)) {
          for(const v of node.items) walk(v, groupCat);
        }

        // ì´ëª¨ì§€ ë ˆì½”ë“œ íŒì •: code/emoji/unified ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì•„ì´í…œìœ¼ë¡œ ê°„ì£¼
        const code = pick(node, ['code','hex','u','unified','unicode','codepoint','cp']);
        const emojiChar = node.emoji || (code ? codeToEmoji(code) : '');

        if (emojiChar || code){
          const key = (code || emojiChar);
          if(!seen.has(key)){
            seen.add(key);
            out.push({
              group: groupCat || pick(node, ['group','category','major','cat']),
              name:  pick(node, ['name','label','cldr','short_name','id']),
              keywords: toArray(pick(node, ['keywords','tags','search'])).join(' '),
              code: (code || '').toUpperCase(),
              emoji: emojiChar,
              png:   pick(node, ['png','pngUrl','url','image','img'])
            });
          }
        }else{
          // ì¼ë°˜ ê°ì²´ë©´ ê°’ë“¤ ì¬ê·€(ìµœëŒ€ í•œ ë‹¨ê³„ ë”)
          for(const v of Object.values(node)) if (v && typeof v === 'object') walk(v, groupCat);
        }
      }
      walk(root, '');
      return out;
    }

    function buildCatMap(items){
      const map = new Map();
      for(const it of items){
        const cat = it.group || 'ê¸°íƒ€';
        if(!map.has(cat)) map.set(cat, []);
        map.get(cat).push(it);
      }
      return map;
    }

    /* ========= 3) ì¹´í…Œê³ ë¦¬ í‘œ ========= */
    function buildCategoryTable(catMap){
      const tbody = UI.catTbody;
      tbody.innerHTML = "";

      const cats = Array.from(catMap.keys());
      const order = ["Smileys & Emotion","People & Body","Animals & Nature","Food & Drink","Travel & Places","Activities","Objects","Symbols","Flags"];
      cats.sort((a,b)=>(order.indexOf(a)===-1?999:order.indexOf(a))-(order.indexOf(b)===-1?999:order.indexOf(b)));

      const columns = (window.innerWidth <= 720) ? 3 : 5;

      for(let i=0;i<cats.length;i+=columns){
        const tr = document.createElement("tr");
        const slice = cats.slice(i, i+columns);
        for(const cat of slice){
          const td  = document.createElement("td");
          const btn = document.createElement("button");
          btn.className="cat-btn"; btn.setAttribute("data-cat", cat);

          const sample = catMap.get(cat)[0];
          const em = document.createElement("span");
          em.className="cat-emoji"; em.textContent = sample?.emoji || "ğŸ˜€";

          const label = document.createElement("span");
          label.className="cat-label"; label.textContent = pickLabel(cat);

          btn.appendChild(em); btn.appendChild(label);
          td.appendChild(btn); tr.appendChild(td);
        }
        if(slice.length<columns) for(let k=0;k<columns-slice.length;k++) tr.appendChild(document.createElement("td"));
        tbody.appendChild(tr);
      }

      ensureTwemoji(tbody); // í‘œ ì´ëª¨ì§€ ì»¬ëŸ¬
      tbody.addEventListener("click",(e)=>{
        const btn = e.target.closest(".cat-btn");
        if(!btn) return;
        setActiveCategory(btn.getAttribute("data-cat"));
      });
    }

    /* ========= 4) ë Œë”ëŸ¬ (ê°„ê²°/ê³ ì†) ========= */
    function hasSprite(it){
      if(!SPRITE_MAP) return false;
      const code = it.code;
      return !!(SPRITE_MAP[code] || (SPRITE_MAP.sprites && SPRITE_MAP.sprites[code]));
    }
    function spriteRec(it){
      const code = it.code;
      return (SPRITE_MAP && (SPRITE_MAP[code] || (SPRITE_MAP.sprites && SPRITE_MAP.sprites[code]))) || null;
    }

    function makeTile(it){
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.title = it.name || it.code || "";

      // 1) ìŠ¤í”„ë¼ì´íŠ¸ ìš°ì„ 
      if (hasSprite(it)) {
        const rec = spriteRec(it);
        if(rec){
          const sheet = rec.sheet || rec.s || rec.sprite || "emoji-top500-1.webp";
          const bx = -(rec.x || rec.left || 0);
          const by = -(rec.y || rec.top  || 0);
          const bw = rec.w || rec.width  || 72;
          const bh = rec.h || rec.height || 72;
          tile.style.backgroundImage = `url(${SPRITES_BASE}${sheet})`;
          tile.style.backgroundPosition = `${bx}px ${by}px`;
          tile.style.backgroundRepeat = "no-repeat";
          tile.style.width  = bw+"px";
          tile.style.height = bh+"px";
          tile.dataset.emoji = it.emoji;
          return tile;
        }
      }

      // 2) PNG(ìˆìœ¼ë©´)
      if (it.png && !(SUPPORT_HINTS?.block?.includes(it.code))) {
        const img = document.createElement("img");
        img.loading="lazy"; img.decoding="async";
        img.src = it.png; img.alt = it.name || it.code || "";
        tile.appendChild(img);
        tile.dataset.emoji = it.emoji;
        return tile;
      }

      // 3) Twemoji PNG(ìµœí›„) â€” ì¦‰ì‹œ ë¬¸ì â†’ ë‹¤ìŒ í‹±ì— PNGë¡œ ëŒ€ì²´
      const span = document.createElement("span");
      span.textContent = it.emoji || "â“";
      span.style.fontSize = "40px";
      tile.appendChild(span);
      setTimeout(()=>ensureTwemoji(tile), 0);
      tile.dataset.emoji = it.emoji || "";
      return tile;
    }

    function renderList(list){
      UI.grid.innerHTML = "";
      let idx = 0;

      // ì²« ì¸ìƒ: ë„‰ë„‰íˆ ê·¸ë ¤ì„œ "ë°”ë¡œ ê½‰ ì±„ì›Œì§" ì²´ê°
      const first = list.slice(0, FIRST_CHUNK);
      const frag1 = document.createDocumentFragment();
      for(const it of first) frag1.appendChild(makeTile(it));
      UI.grid.appendChild(frag1);
      idx = FIRST_CHUNK;

      // ì´í›„ëŠ” ìŠ¤í¬ë¡¤ì— ë§ì¶° ê°€ë³ê²Œ ì¶”ê°€
      function addNext(){
        if(idx >= list.length) return;
        const part = list.slice(idx, idx + NEXT_CHUNK);
        const frag = document.createDocumentFragment();
        for(const it of part) frag.appendChild(makeTile(it));
        UI.grid.appendChild(frag);
        idx += NEXT_CHUNK;
      }

      const onScroll = ()=>{
        const bottom = window.scrollY + window.innerHeight;
        const near   = document.body.offsetHeight - 800;
        if(bottom > near) addNext();
      };
      window.removeEventListener('scroll', onScroll);
      window.addEventListener('scroll', onScroll, { passive:true });
    }

    /* ========= 5) ì¹´í…Œê³ ë¦¬/ê²€ìƒ‰ ========= */
    function setActiveCategory(cat){
      ACTIVE_CAT = cat;
      document.querySelectorAll(".cat-btn").forEach(b=>b.classList.toggle("active", b.getAttribute("data-cat")===cat));
      BASE_LIST = CAT_MAP.get(cat) || [];
      applySearch();
    }

    function applySearch(){
      const q = UI.search.value.trim().toLowerCase();
      VIEW_LIST = !q ? BASE_LIST : BASE_LIST.filter(it=>{
        const name = (it.name||"").toLowerCase();
        const kws  = (it.keywords||"").toLowerCase();
        return name.includes(q) || kws.includes(q);
      });

      hideStatus();
      if(VIEW_LIST.length === 0){ showStatus("í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ì´ëª¨ì§€ê°€ ì—†ìŠµë‹ˆë‹¤."); }
      renderList(VIEW_LIST);
    }

    /* ========= 6) ë³µì‚¬ ========= */
    async function copyToClipboard(text){
      try{ await navigator.clipboard.writeText(text); showToast("ë³µì‚¬ ì™„ë£Œ!"); }
      catch(_){ UI.copyOut.value=text; UI.copyOut.select(); document.execCommand('copy'); showToast("ë³µì‚¬ ì™„ë£Œ!"); }
    }

    /* ========= 7) ë¶€íŠ¸ìŠ¤íŠ¸ë© ========= */
    (async function boot(){
      showStatus("ë°ì´í„° ë¡œë“œ ì¤‘â€¦");
      const ok = await loadData();
      if(!ok) return;

      const items = normalizeItems(BUILD);
      if(items.length === 0){ showStatus("ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤."); return; }

      CAT_MAP = buildCatMap(items);
      buildCategoryTable(CAT_MAP);

      // ì´ˆê¸° ì¹´í…Œê³ ë¦¬: ìŠ¤ë§ˆì¼/ê°ì • ìš°ì„ 
      const pref = ["Smileys & Emotion","ìŠ¤ë§ˆì¼/ê°ì •"];
      const firstCat = [...CAT_MAP.keys()].find(k=>pref.includes(k)) || [...CAT_MAP.keys()][0];
      setActiveCategory(firstCat);
    })();

    /* ========= 8) ì´ë²¤íŠ¸ ========= */
    UI.search.addEventListener('input', ()=>applySearch());
    UI.grid.addEventListener('click', (e)=>{
      const tile = e.target.closest('.tile'); if(!tile) return;
      const emoji = tile.dataset.emoji || ''; if(!emoji) return;
      UI.copyOut.value = emoji; copyToClipboard(emoji);
    });
    UI.btnCopy.addEventListener('click', ()=>{ const v=UI.copyOut.value||''; if(v) copyToClipboard(v); });
    window.addEventListener('resize', ()=>{
      if(!CAT_MAP) return;
      buildCategoryTable(CAT_MAP);
      if(ACTIVE_CAT) setActiveCategory(ACTIVE_CAT);
    });
  </script>
</body>
</html>
