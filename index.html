<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>프로 이모지 검색 — 하이브리드 인라인 PRO (36개 + 더보기)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{
      --grid-width:520px;   /* 초기 LCP 최소화. 필요 시 560px */
      --tile:72px;
      --gap:8px;
      --maxw:1100px;
      --cat-h:48px;
      --cat-f:15px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple Color Emoji,Noto Color Emoji,sans-serif}

    /* 상단: 검색 + 복사 */
    #toolbar{position:sticky;top:0;z-index:9;background:#fff;border-bottom:1px solid #eee}
    #toolbar .in{max-width:var(--maxw);margin:0 auto;padding:10px 12px;display:grid;gap:8px;grid-template-columns:1fr auto;align-items:center}
    #search{height:40px;border:1px solid #ddd;border-radius:8px;padding:0 12px;font-size:15px}
    #copyBox{display:flex;gap:8px;align-items:center}
    #copyOut{width:160px;height:40px;border:1px solid #ddd;border-radius:8px;padding:0 12px;font-size:16px}
    #btnCopy{height:40px;padding:0 14px;border:1px solid #333;background:#111;color:#fff;border-radius:8px;cursor:pointer}

    /* 카테고리 표 */
    #catWrap{position:sticky;top:60px;z-index:8;background:#fff;border-bottom:1px solid #eee}
    #catWrap .in{max-width:var(--maxw);margin:0 auto;padding:8px 12px}
    table.cat{width:100%;table-layout:fixed;border-collapse:collapse;font-size:var(--cat-f)}
    table.cat td{padding:0;border:1px solid #f1f1f1}
    .cat-btn{width:100%;height:var(--cat-h);display:grid;grid-template-columns:28px 1fr;gap:8px;align-items:center;padding:8px 10px;border:0;background:#fff;cursor:pointer}
    .cat-btn:hover{background:#fafafa}
    .cat-btn.active{outline:2px solid rgba(0,0,0,.08);background:#f9f9ff}
    .cat-emo{width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;font-size:20px}
    .cat-lab{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;text-align:left}

    /* 그리드 */
    #gridWrap{max-width:var(--grid-width);margin:12px auto 60px;padding:0 8px}
    #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--tile),1fr));gap:var(--gap)}
    .tile{width:var(--tile);height:var(--tile);display:inline-flex;align-items:center;justify-content:center;border-radius:10px;border:1px solid #eee;background:#fff;cursor:pointer;user-select:none;transition:transform .04s}
    .tile:hover{transform:translateY(-1px);background:#fafafa}
    .tile img{width:var(--tile);height:var(--tile);image-rendering:-webkit-optimize-contrast}

    /* 더보기 버튼 */
    #moreWrap{max-width:var(--grid-width);margin:-4px auto 40px;padding:0 8px;display:none}
    #btnMore{width:100%;height:44px;border:1px solid #ddd;background:#fff;border-radius:10px;cursor:pointer;font-size:15px}
    #btnMore[disabled]{opacity:.6;cursor:default}

    /* 상태/토스트/법적 */
    #status{max-width:960px;margin:16px auto 0;padding:8px 12px;color:#444;text-align:center;display:none;font-size:14px}
    #toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);z-index:20;background:rgba(0,0,0,.8);color:#fff;padding:8px 12px;border-radius:20px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s}
    #toast.show{opacity:1}
    #legal{max-width:var(--maxw);margin:24px auto 40px;padding:0 12px;font-size:12px;color:#777}
    #legal a{color:inherit;text-decoration:underline}

    @media (max-width:720px){
      :root{--cat-f:14px}
      #toolbar .in{grid-template-columns:1fr}
      #catWrap{top:112px}
    }
  </style>
  <!-- Twemoji PNG (SVG OFF) -->
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <!-- 상단 -->
  <header id="toolbar">
    <div class="in">
      <input id="search" type="search" placeholder="이모지 이름(name_*)으로 검색 (현재 카테고리 내)"/>
      <div id="copyBox">
        <input id="copyOut" type="text" readonly placeholder="복사할 이모지"/>
        <button id="btnCopy" type="button">복사</button>
      </div>
    </div>
  </header>

  <!-- 카테고리 -->
  <section id="catWrap">
    <div class="in">
      <table class="cat"><tbody id="catBody"></tbody></table>
    </div>
  </section>

  <!-- 상태/그리드/더보기/토스트 -->
  <div id="status"></div>
  <main id="gridWrap"><section id="grid"></section></main>
  <div id="moreWrap"><button id="btnMore" type="button">더보기</button></div>
  <div id="toast">복사 완료!</div>

  <!-- 법적 표기 -->
  <footer id="legal">
    Emoji graphics by <a href="https://twemoji.twitter.com/" target="_blank" rel="noopener">Twemoji</a> © Twitter,
    licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0</a>.
    Unicode data © The Unicode Consortium.
  </footer>

  <!-- 🔹 인라인 데이터: People & Body(피플/바디) — 최소 36개 이상 주입 권장 -->
  <!--  운영 시 빌드 단계에서 이 배열을 'People & Body' 카테고리 전체로 주입하세요.
      (필드: group, name/name_ko/name_en, code(선택), emoji) -->
  <script type="application/json" id="INLINE_PEOPLE">
  [
    {"group":"People & Body","name":"person","emoji":"🧑"},
    {"group":"People & Body","name":"man","emoji":"👨"},
    {"group":"People & Body","name":"woman","emoji":"👩"},
    {"group":"People & Body","name":"boy","emoji":"👦"},
    {"group":"People & Body","name":"girl","emoji":"👧"},
    {"group":"People & Body","name":"baby","emoji":"👶"},
    {"group":"People & Body","name":"old man","emoji":"👴"},
    {"group":"People & Body","name":"old woman","emoji":"👵"},
    {"group":"People & Body","name":"person gesturing OK","emoji":"🙆"},
    {"group":"People & Body","name":"person gesturing NO","emoji":"🙅"},
    {"group":"People & Body","name":"person raising hand","emoji":"🙋"},
    {"group":"People & Body","name":"person bowing","emoji":"🙇"},
    {"group":"People & Body","name":"person walking","emoji":"🚶"},
    {"group":"People & Body","name":"person running","emoji":"🏃"},
    {"group":"People & Body","name":"person biking","emoji":"🚴"},
    {"group":"People & Body","name":"person swimming","emoji":"🏊"},
    {"group":"People & Body","name":"waving hand","emoji":"👋"},
    {"group":"People & Body","name":"thumbs up","emoji":"👍"},
    {"group":"People & Body","name":"thumbs down","emoji":"👎"},
    {"group":"People & Body","name":"clapping hands","emoji":"👏"},
    {"group":"People & Body","name":"raising hands","emoji":"🙌"},
    {"group":"People & Body","name":"folded hands","emoji":"🙏"},
    {"group":"People & Body","name":"handshake","emoji":"🤝"},
    {"group":"People & Body","name":"victory hand","emoji":"✌️"},
    {"group":"People & Body","name":"crossed fingers","emoji":"🤞"},
    {"group":"People & Body","name":"OK hand","emoji":"👌"},
    {"group":"People & Body","name":"call me hand","emoji":"🤙"},
    {"group":"People & Body","name":"backhand index pointing left","emoji":"👈"},
    {"group":"People & Body","name":"backhand index pointing right","emoji":"👉"},
    {"group":"People & Body","name":"backhand index pointing up","emoji":"👆"},
    {"group":"People & Body","name":"backhand index pointing down","emoji":"👇"},
    {"group":"People & Body","name":"raised hand","emoji":"✋"},
    {"group":"People & Body","name":"raised back of hand","emoji":"🤚"},
    {"group":"People & Body","name":"vulcan salute","emoji":"🖖"},
    {"group":"People & Body","name":"sign of the horns","emoji":"🤘"},
    {"group":"People & Body","name":"love-you gesture","emoji":"🤟"},
    {"group":"People & Body","name":"flexed biceps","emoji":"💪"},
    {"group":"People & Body","name":"leg","emoji":"🦵"},
    {"group":"People & Body","name":"foot","emoji":"🦶"},
    {"group":"People & Body","name":"ear","emoji":"👂"},
    {"group":"People & Body","name":"nose","emoji":"👃"},
    {"group":"People & Body","name":"eyes","emoji":"👀"},
    {"group":"People & Body","name":"mouth","emoji":"👄"},
    {"group":"People & Body","name":"tongue","emoji":"👅"}
    /* ⇧ 실제 운용 시 People & Body 전체로 대체 */
  ]
  </script>

  <script type="module">
    /* =========================
       0) 상수/유틸
    ==========================*/
    const BASE = (()=>{ const p=location.pathname.split('/').filter(Boolean); return p.length?`/${p[0]}/`:'/' })();
    const DATA_BASE    = BASE + 'data/';
    const SPRITES_BASE = BASE + 'sprites/';

    const INITIAL_COUNT = 36;      // 첫 화면 개수(안전값)
    const NEXT_CHUNK    = 240;     // 더보기 이후 자동 부착 청크
    const PREF = ["People & Body","피플/바디"];  // 기본 카테고리

    const UI = {
      search:   document.getElementById('search'),
      copyOut:  document.getElementById('copyOut'),
      btnCopy:  document.getElementById('btnCopy'),
      status:   document.getElementById('status'),
      grid:     document.getElementById('grid'),
      moreWrap: document.getElementById('moreWrap'),
      btnMore:  document.getElementById('btnMore'),
      catBody:  document.getElementById('catBody'),
      toast:    document.getElementById('toast'),
    };

    const twemojiParse = (el)=> window.twemoji?.parse(el,{ base:"https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/", folder:"72x72", ext:".png" });
    const showStatus = (m)=>{ UI.status.style.display='block'; UI.status.innerHTML = m; };
    const hideStatus = ()=>{ UI.status.style.display='none'; UI.status.textContent=''; };
    const toast = (t="복사 완료!")=>{ UI.toast.textContent=t; UI.toast.classList.add('show'); setTimeout(()=>UI.toast.classList.remove('show'),900); };

    const codeToEmoji = (code)=>{ try{ return String.fromCodePoint(...String(code).split('-').map(h=>parseInt(h,16))); }catch(_){ return "❓"; } };
    const pick = (obj, keys)=>{ for(const k of keys){ if(obj[k]!=null && obj[k]!=="") return obj[k];
      const k2 = Object.keys(obj).find(x=>x.toLowerCase()===k.toLowerCase()); if(k2 && obj[k2]!=null && obj[k2]!=="") return obj[k2]; } return ''; };

    const KO = {"Smileys & Emotion":"스마일/감정","People & Body":"피플/바디","Animals & Nature":"동물/자연","Food & Drink":"음식/음료","Travel & Places":"여행/장소","Activities":"활동","Objects":"사물","Symbols":"기호","Flags":"국기"};
    const ORDER = ["Smileys & Emotion","People & Body","Animals & Nature","Food & Drink","Travel & Places","Activities","Objects","Symbols","Flags"];
    const label = (raw)=> KO[raw] || raw || "기타";

    // 상태
    let BUILD=null, SPRITE_MAP=null, SUPPORT_HINTS=null;
    let ALL_ITEMS=[], CAT_MAP=new Map();
    let ACTIVE_CAT=null, BASE_LIST=[], VIEW_LIST=[], RENDERED_COUNT=0;

    async function fetchJSON(u){ try{ const r=await fetch(u,{cache:"no-cache"}); if(r.ok) return await r.json(); }catch(_){ } return null; }

    /* =========================
       1) 정규화/카테고리
    ==========================*/
    function normalizeItems(root){
      const out=[]; const seen=new Set();
      (function walk(node, inherited=''){
        if(!node) return;
        if(Array.isArray(node)){ for(const v of node) walk(v, inherited); return; }
        if(typeof node!=='object') return;
        const group = pick(node, ['group','category','major','cat','section','type']) || inherited;
        if (Array.isArray(node.items)) { for(const v of node.items) walk(v, group); }
        const code = pick(node, ['code','hex','u','unified','unicode','codepoint','cp']);
        const emojiChar = node.emoji || (code ? codeToEmoji(code) : '');
        if (emojiChar || code){
          const key = code || emojiChar;
          if(seen.has(key)) return; seen.add(key);
          const nameFields = Object.keys(node).filter(k=>/^name[_-]/i.test(k)||k==='name');
          const names = nameFields.map(k=>String(node[k])).filter(Boolean);
          const primary = pick(node,['name_ko','name_kr','name_korean','name']) || pick(node,['name_en','label','cldr','short_name','id']) || '';
          out.push({
            group: group || pick(node,['group','category','major','cat']) || '기타',
            name: primary,
            nameText: [primary, ...names].join(' ').trim().toLowerCase(),
            code: (code||'').toUpperCase(),
            emoji: emojiChar,
            png: pick(node, ['png','pngUrl','url','image','img'])
          });
        }else{
          for(const v of Object.values(node)) if(v && typeof v==='object') walk(v, group);
        }
      })(root,'');
      return out;
    }

    function rebuildCatMap(items){
      const m=new Map();
      for(const it of items){
        const c=it.group||'기타';
        if(!m.has(c)) m.set(c, []);
        m.get(c).push(it);
      }
      for(const [k,arr] of m.entries()){
        arr.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'ko'));
      }
      return m;
    }

    function buildCategoryTable(map){
      const tbody = UI.catBody; tbody.innerHTML="";
      const cats = Array.from(map.keys()).sort((a,b)=>(ORDER.indexOf(a)===-1?999:ORDER.indexOf(a))-(ORDER.indexOf(b)===-1?999:ORDER.indexOf(b)));
      const cols = (innerWidth<=720)?3:5;
      for(let i=0;i<cats.length;i+=cols){
        const tr=document.createElement('tr');
        for(const cat of cats.slice(i,i+cols)){
          const td=document.createElement('td');
          const btn=document.createElement('button');
          btn.className='cat-btn'; btn.dataset.cat=cat;
          const em=document.createElement('span'); em.className='cat-emo'; em.textContent = (map.get(cat)||[])[0]?.emoji || '😀';
          const la=document.createElement('span'); la.className='cat-lab'; la.textContent = label(cat);
          btn.append(em,la); td.appendChild(btn); tr.appendChild(td);
        }
        while(tr.children.length<cols) tr.appendChild(document.createElement('td'));
        tbody.appendChild(tr);
      }
      twemojiParse(tbody);
      tbody.onclick = async (e)=>{
        const b=e.target.closest('.cat-btn'); if(!b) return;
        const nextCat=b.dataset.cat;
        // 외부 데이터가 아직 병합 전이고, 다른 카테고리면 선로드
        if(nextCat!==ACTIVE_CAT && nextCat!=="People & Body" && !BUILD){
          showStatus("데이터 로드 중…");
          await loadExternalIfNeeded();
          hideStatus();
        }
        setActiveCategory(nextCat);
      };
    }

    /* =========================
       2) 렌더(36개 + 더보기 → 전량)
    ==========================*/
    function hasSprite(it){ return SPRITE_MAP && (SPRITE_MAP[it.code] || (SPRITE_MAP.sprites && SPRITE_MAP.sprites[it.code])); }
    function spriteRec(it){ return (SPRITE_MAP && (SPRITE_MAP[it.code] || (SPRITE_MAP.sprites && SPRITE_MAP.sprites[it.code]))) || null; }

    function makeTile(it){
      const t=document.createElement('div'); t.className='tile'; t.title=it.name||it.code||'';
      // 1) 스프라이트
      if(hasSprite(it)){
        const rec=spriteRec(it);
        const sheet=(rec.sheet||rec.s||rec.sprite||'emoji-top500-1.webp');
        const bx=-(rec.x||rec.left||0), by=-(rec.y||rec.top||0);
        const bw=rec.w||rec.width||72, bh=rec.h||rec.height||72;
        t.style.backgroundImage=`url(${SPRITES_BASE}${sheet})`;
        t.style.backgroundPosition=`${bx}px ${by}px`;
        t.style.backgroundRepeat='no-repeat';
        t.style.width=bw+'px'; t.style.height=bh+'px';
        t.dataset.emoji=it.emoji; return t;
      }
      // 2) PNG
      if(it.png && !(SUPPORT_HINTS?.block?.includes(it.code))){
        const img=document.createElement('img'); img.loading='lazy'; img.decoding='async';
        img.src=it.png; img.alt=it.name||it.code||''; t.appendChild(img);
        t.dataset.emoji=it.emoji; return t;
      }
      // 3) Twemoji(최후)
      const s=document.createElement('span'); s.textContent=it.emoji || codeToEmoji(it.code); s.style.fontSize='40px';
      t.appendChild(s); twemojiParse(t);
      t.dataset.emoji=it.emoji||''; return t;
    }

    function renderInitial(list){
      UI.grid.innerHTML="";
      RENDERED_COUNT = Math.min(INITIAL_COUNT, list.length);
      const frag=document.createDocumentFragment();
      for(let i=0;i<RENDERED_COUNT;i++) frag.appendChild(makeTile(list[i]));
      UI.grid.appendChild(frag);

      // 더보기 노출 제어
      if(list.length > RENDERED_COUNT){
        UI.moreWrap.style.display='block';
        UI.btnMore.disabled=false; UI.btnMore.textContent='더보기';
      }else{
        UI.moreWrap.style.display='none';
      }
    }

    function renderRestAuto(list){
      UI.btnMore.disabled=true; UI.btnMore.textContent='불러오는 중…';
      let idx = RENDERED_COUNT;
      const step = ()=>{
        if(idx >= list.length){
          UI.moreWrap.style.display='none';
          return;
        }
        const end = Math.min(idx + NEXT_CHUNK, list.length);
        const frag=document.createDocumentFragment();
        for(let i=idx;i<end;i++) frag.appendChild(makeTile(list[i]));
        UI.grid.appendChild(frag);
        idx = end; RENDERED_COUNT = idx;
        if(idx < list.length) setTimeout(step, 0);
        else UI.moreWrap.style.display='none';
      };
      step();
    }

    /* =========================
       3) 카테고리/검색
    ==========================*/
    function setActiveCategory(cat){
      ACTIVE_CAT = cat;
      document.querySelectorAll('.cat-btn').forEach(b=> b.classList.toggle('active', b.dataset.cat===cat));
      BASE_LIST = CAT_MAP.get(cat) || [];
      applySearch();  // 초기 36개 + 더보기
    }

    function applySearch(){
      const q = UI.search.value.trim().toLowerCase();
      VIEW_LIST = !q ? BASE_LIST : BASE_LIST.filter(it => (it.nameText || it.name || '').includes(q));
      renderInitial(VIEW_LIST);
      showStatus(`카테고리: <b>${label(ACTIVE_CAT)}</b> · 항목: <b>${VIEW_LIST.length.toLocaleString()}</b> (첫 화면 ${INITIAL_COUNT}개)`);
    }

    /* =========================
       4) 데이터(인라인 → 외부 선로딩/병합)
    ==========================*/
    async function hydrateExternalData(){
      // 백그라운드 선로딩(캐시 워밍)
      fetch(DATA_BASE + 'build.json').catch(()=>{});
      fetch(SPRITES_BASE + 'SPRITE_MAP.json').catch(()=>{});
      fetch(SPRITES_BASE + 'SUPPORT_HINTS.json').catch(()=>{});
    }

    async function loadExternalIfNeeded(){
      if(BUILD && SPRITE_MAP!==null) return true; // 이미 병합됨
      BUILD = await fetchJSON(DATA_BASE + 'build.json');
      SPRITE_MAP = await fetchJSON(SPRITES_BASE + 'SPRITE_MAP.json') || SPRITE_MAP;
      SUPPORT_HINTS = await fetchJSON(SPRITES_BASE + 'SUPPORT_HINTS.json') || SUPPORT_HINTS;
      if(!BUILD) return false;

      const root = BUILD.items || BUILD.emojis || BUILD.data || BUILD.rows || BUILD;
      const ext  = Array.isArray(root) ? normalizeItems(root) : normalizeItems([root]);

      const seen = new Set(ALL_ITEMS.map(x=>x.code||x.emoji));
      const merged = ALL_ITEMS.slice();
      for(const it of ext){
        const key=it.code||it.emoji;
        if(!seen.has(key)){ seen.add(key); merged.push(it); }
      }
      ALL_ITEMS = merged;
      CAT_MAP   = rebuildCatMap(ALL_ITEMS);
      buildCategoryTable(CAT_MAP);
      return true;
    }

    /* =========================
       5) 복사/이벤트
    ==========================*/
    async function copyToClipboard(text){
      try{ await navigator.clipboard.writeText(text); toast(); }
      catch(_){ UI.copyOut.value=text; UI.copyOut.select(); document.execCommand('copy'); toast(); }
    }
    UI.btnCopy.addEventListener('click', ()=>{ const v=UI.copyOut.value||''; if(v) copyToClipboard(v); });
    UI.grid.addEventListener('click', (e)=>{
      const t=e.target.closest('.tile'); if(!t) return;
      const emoji=t.dataset.emoji||''; if(!emoji) return;
      UI.copyOut.value = emoji; copyToClipboard(emoji);
    });
    UI.search.addEventListener('input', ()=>applySearch());
    UI.btnMore.addEventListener('click', ()=> renderRestAuto(VIEW_LIST));

    window.addEventListener('resize', ()=>{
      if(!CAT_MAP.size) return;
      buildCategoryTable(CAT_MAP);
      setActiveCategory(ACTIVE_CAT);
    });

    /* =========================
       6) 부트스트랩
    ==========================*/
    (async function boot(){
      showStatus("초기 데이터 준비 중…");

      // (A) 인라인 People & Body 즉시 표시
      const inlinePeople = JSON.parse(document.getElementById('INLINE_PEOPLE').textContent || "[]");
      const normPeople = normalizeItems(inlinePeople);
      ALL_ITEMS = normPeople;
      CAT_MAP   = rebuildCatMap(ALL_ITEMS);
      buildCategoryTable(CAT_MAP);

      // 기본 카테고리: People & Body (없으면 첫 카테고리)
      const first = [...CAT_MAP.keys()].find(k=>PREF.includes(k)) || [...CAT_MAP.keys()][0];
      setActiveCategory(first);
      hideStatus();

      // (B) 외부 데이터 선로딩
      hydrateExternalData();

      // (C) 사용자가 다른 카테고리로 이동하면, 그 시점에 병합(이미 선로딩된 상태라 즉시 반응)
      // → 위 카테고리 버튼 클릭 핸들러에서 처리
    })();
  </script>
</body>
</html>
