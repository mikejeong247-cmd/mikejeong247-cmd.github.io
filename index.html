<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emoji Search — Pro (FAST On-Demand)</title>

  <!-- 네트워크 핸드셰이크 단축 -->
  <link rel="dns-prefetch" href="https://docs.google.com">
  <link rel="preconnect" href="https://docs.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <style>
    :root{
      /* ===== 속도 스위치: 숫자만 조정 ===== */
      --search-h:44px;
      --grid-width:600px;
      --cols:30;           /* 27→30 */
      --emoji-size:13px;   /* 15→13 */
      --grid-gap:1px;      /* 2→1 */
      --cat-gap-between:80px;
      --cat-to-grid-gap:16px;
    }
    body{font-family:system-ui,apple sd gothic neo,Segoe UI,Roboto,Helvetica,Arial;margin:16px;color:#222}
    .toolbar{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
    .searchwrap{width:100%;max-width:680px;min-width:260px}
    .search{width:100%;height:var(--search-h);padding:0 14px;font-size:16px;border:1px solid #ddd;border-radius:12px;outline:none}

    .copywrap{width:100%;max-width:680px;min-width:260px;margin:6px auto 14px}
    .copybar{height:calc(var(--search-h)*2);border:1px dashed #ddd;border-radius:12px;
      padding:8px 10px;overflow:auto;display:flex;flex-wrap:wrap;align-items:flex-start;gap:6px}
    .copyhint{width:100%;color:#666;font-size:12px}
    .copyglyph{display:inline-block;width:25px;height:25px;background-size:contain;background-repeat:no-repeat;background-position:center;line-height:1;border-radius:4px;border:1px solid #eee}

    #list{display:block}
    .sec{margin:0 0 var(--cat-gap-between);contain-intrinsic-size:1000px}
    .cat{font-weight:700;font-size:18px;margin:6px 0 var(--cat-to-grid-gap);display:flex;align-items:center;gap:6px;justify-content:center}
    .cnt{color:#999;font-weight:400;font-size:12px}
    .lazy{content-visibility:auto} /* 온디맨드 */

    .emojis{width:var(--grid-width);margin:0 auto;display:grid;
      grid-template-columns:repeat(var(--cols),1fr);justify-items:start;align-items:center;gap:var(--grid-gap)}

    .e{width:var(--emoji-size);height:var(--emoji-size);display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none}
    .glyph{display:inline-block;width:var(--emoji-size);height:var(--emoji-size);
      background-size:contain;background-repeat:no-repeat;background-position:center;line-height:var(--emoji-size);font-size:var(--emoji-size);text-align:center}

    .d{display:none}
    body.searching .emojis{display:grid}
    body.searching .e{width:auto;height:auto;display:flex;align-items:flex-start;gap:6px;margin:2px 0}
    body.searching .glyph{font-size:var(--emoji-size);line-height:1;margin-top:2px;width:auto;height:auto}
    body.searching .d{display:block}
    .nm{font-weight:700;font-size:12px;margin-bottom:2px}
    .kw{color:#666;font-size:11px}
    mark{background:#fff2a8;padding:0 .5px;border-radius:2px}
    .zero{margin-top:12px;color:#666;text-align:center}

    html[dir="rtl"] .cat{direction:rtl}
    html[dir="rtl"] .emojis{direction:rtl}

    footer{margin-top:28px;color:#777;font-size:12px;text-align:center;line-height:1.6}
    footer a{color:#777;text-decoration:underline}
  </style>
</head>
<body>
  <div class="toolbar"><div class="searchwrap"><input id="q" class="search" placeholder=""></div></div>
  <div class="copywrap"><div id="copybar" class="copybar"><span id="copyhint" class="copyhint"></span></div></div>

  <div id="list"></div>
  <div id="loading" class="zero" style="display:none;">데이터 불러오는 중…</div>
  <div id="zero" class="zero" style="display:none;">결과가 없습니다.</div>

  <footer>
    Emoji graphics via
    <a href="https://github.com/twitter/twemoji">Twemoji</a>,
    <a href="https://openmoji.org">OpenMoji</a>,
    <a href="https://github.com/googlefonts/noto-emoji">Noto Emoji</a>.
    Licenses: CC BY 4.0 / CC BY-SA 4.0 / OFL 1.1.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  /* ===== 0) 설정 ===== */
  const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_RAfp9VnhQCpOkq9fBnu3b44r6jTB9EyT4qefGNSOf7R0SKuvEt_OvFs_qHLFQA9a3VRade4mxsjA/pub?gid=1543598799&single=true&output=csv";

  const NAME_FIELDS_BASE = ["name_ko","name_ja","name_zh-cn","name_en","name_es","name_ar","name_pt","name_ru","name_fr","name_tr","name_id","name_hi","name_de"];
  const SAFE_FIELDS_BASE = ["keywords_ko_safe","keywords_ja_safe","keywords_zh-cn_safe","keywords_es_safe","keywords_ar_safe","keywords_pt_safe","keywords_ru_safe","keywords_fr_safe","keywords_tr_safe","keywords_id_safe","keywords_hi_safe","keywords_de_safe"];

  const MAX_RESULTS = Infinity;
  const SCORE = { nameHit:3, tokenHit:1, categoryHit:0.5 };
  const MIN_LATIN_TOKEN_LEN = 3;

  /* 속도 스위치 */
  const ABOVE_FOLD_CATS = 2;   // 첫 2개 섹션 즉시 렌더
  const EMOJI_CHUNK     = 360; // 타일 분할 단위
  const IDLE_TIMEOUT    = 60;  // requestIdleCallback timeout(ms)

  /* ===== 1) i18n & RTL ===== */
  const rawLang=(navigator.language||"en").toLowerCase();
  if(/^(ar|fa|ur|he)(-|$)/i.test(rawLang)) document.documentElement.setAttribute('dir','rtl');
  const LC = rawLang.startsWith("zh") ? (rawLang.includes("tw")||rawLang.includes("hk")?"zh-tw":"zh-cn") : rawLang.split("-")[0];
  const I18N_TEXT={placeholder:{"ko":"검색","ja":"検索","zh-cn":"搜索","zh-tw":"搜尋","en":"Search","es":"Buscar","ar":"بحث","pt":"Pesquisar","ru":"Поиск","fr":"Rechercher","tr":"Ara","id":"Cari","hi":"खोजें","de":"Suchen"},
                   copyHint:{"ko":"이모지를 누르면 복사됩니다","ja":"絵文字をクリックするとコピーされます","zh-cn":"点击表情即可复制","zh-tw":"點擊表情即可複製","en":"Click emoji to copy","es":"Haz clic en un emoji para copiarlo","ar":"انقر على الإيموجी للنسخ","pt":"Clique no emoji para copiar","ru":"Нажмите на эмодзи, чтобы скопировать","fr":"Cliquez sur un emoji pour copier","tr":"Emojiyi kopyalamak için tıklayın","id":"Klik emoji untuk menyalin","hi":"इमोजी पर 클릭 करें, कॉपी हो जाएगा","de":"Emoji anklicken zum Kopieren"}};
  (function(){document.getElementById('q').placeholder=(I18N_TEXT.placeholder[LC]||I18N_TEXT.placeholder.en)+'…'; document.getElementById('copyhint').textContent=I18N_TEXT.copyHint[LC]||I18N_TEXT.copyHint.en;})();

  /* ===== 2) 유틸 ===== */
  const rmDiacritics=s=>(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  const toLower=s=>rmDiacritics(String(s||"")).toLowerCase();
  const splitLatin=s=>toLower(s).split(/[^a-z0-9]+/).filter(t=>t.length>=MIN_LATIN_TOKEN_LEN);
  const uniq=arr=>[...new Set(arr)];
  const isLatin=s=>/^[a-z0-9\s,._-]+$/i.test(rmDiacritics(s||""));
  const esc=s=>(s||"").replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]));
  const rIC=window.requestIdleCallback ? (cb)=>window.requestIdleCallback(cb,{timeout:IDLE_TIMEOUT}) : (cb)=>setTimeout(cb,0);

  /* ===== 3) 멀티 CDN 폴백 + 스프라이트 자동 ===== */
  // 스프라이트 자동 감지(있으면 우선 적용)
  let RENDERER_MODE='sprite';
  const SPRITE_CDN_BASE='/sprites';
  let SPRITE_MAP=null;
  (async function(){try{
    const res=await fetch(`${SPRITE_CDN_BASE}/SPRITE_MAP.json?ts=${Date.now()}`,{cache:'no-cache'});
    if(res.ok){SPRITE_MAP=await res.json(); RENDERER_MODE='sprite';} else {RENDERER_MODE='cdn';}
  }catch(e){RENDERER_MODE='cdn';}})();

  const TWEMOJI_BASE='https://cdn.jsdelivr.net/gh/twitter/twemoji@14/assets';
  const OPENMOJI_BASE='https://cdn.jsdelivr.net/npm/openmoji@14.0.0/color/svg';
  const NOTO_BASE    ='https://cdn.jsdelivr.net/gh/googlefonts/noto-emoji/svg';

  function normalizeSeq(code, emojiText){
    let s=(code||'').toLowerCase().trim();
    s=s.replace(/^[a-z]+\s+/,'').replace(/u\+/g,'').replace(/[_\s]+/g,'-');
    if(!/^[0-9a-f]+(-[0-9a-f]+)*$/.test(s) || !s){
      if(emojiText){const cps=[]; for(const ch of emojiText) cps.push(ch.codePointAt(0).toString(16)); s=cps.join('-');}
      else s='';
    }
    return s;
  }
  function withVariants(seq){
    const parts=seq.split('-').filter(Boolean);
    const noVS=parts.filter(p=>p!=='fe0f').join('-');
    const withVS=parts.join('-');
    return [...new Set([withVS,noVS])];
  }
  function getEmojiUrls(code, emojiText){
    const seqs=withVariants(normalizeSeq(code,emojiText));
    const urls=[];
    // Twemoji
    for(const s of seqs) urls.push(`${TWEMOJI_BASE}/svg/${s}.svg`);
    // OpenMoji (UPPER)
    for(const s of seqs) urls.push(`${OPENMOJI_BASE}/${s.toUpperCase()}.svg`);
    // Noto (emoji_uXXXX[-XXXX].svg)
    for(const s of seqs){
      const u='emoji_u'+s.replace(/\b([0-9a-f]{1,6})\b/g,'u$1').replace(/-u/g,'-');
      urls.push(`${NOTO_BASE}/${u}.svg`);
    }
    return urls;
  }
  function paintGlyphEl(el, code, emojiText){
    const seq=normalizeSeq(code,emojiText);
    // 스프라이트 우선
    if(RENDERER_MODE==='sprite' && SPRITE_MAP && SPRITE_MAP[seq]){
      const m=SPRITE_MAP[seq]; el.textContent='';
      el.style.backgroundImage=`url(${SPRITE_CDN_BASE}/${m.sheet})`;
      el.style.backgroundPosition=`-${m.x}px -${m.y}px`;
      el.style.backgroundSize='auto'; el.style.backgroundRepeat='no-repeat'; el.style.display='inline-block';
      return;
    }
    // 멀티 CDN 폴백
    const candidates=getEmojiUrls(seq,emojiText); let i=0;
    const tryNext=()=>{
      const url=candidates[i++]; if(!url){ el.textContent=emojiText||'⬜'; el.style.backgroundImage=''; return; }
      const img=new Image(); img.decoding='async';
      img.onload=()=>{ el.textContent=''; el.style.backgroundImage=`url(${url})`; el.style.backgroundSize='contain'; el.style.backgroundRepeat='no-repeat'; el.style.backgroundPosition='center'; el.style.display='inline-block'; };
      img.onerror=tryNext; img.src=url;
    };
    tryNext();
  }
  function paintNewGlyphs(container){
    container.querySelectorAll('.e:not([data-painted])').forEach(tile=>{
      paintGlyphEl(tile.querySelector('.glyph'), tile.getAttribute('data-code'), tile.getAttribute('data-emoji'));
      tile.setAttribute('data-painted','1');
    });
  }

  /* ===== 4) 데이터 로드 & 인덱스 ===== */
  let rows=[], ready=false, charIndex={}, tokenIndex={};

  const workerSrc=`self.onmessage=e=>{const{type,data}=e.data||{};if(type!=="build")return;
    const c=Object.create(null),t=Object.create(null),L=x=>/[a-z0-9]/i.test(x);
    for(const it of data){const i=it.i|0;const S=new Set(it.idxChars.split(""));for(const ch of S){if(!ch||L(ch)||" ,._-".includes(ch))continue;(c[ch]||(c[ch]=[])).push(i);}
      for(const tk of it.idxLatinTokens||[]){if(!tk)continue;(t[tk]||(t[tk]=[])).push(i);}}
    for(const k in c)c[k].sort((a,b)=>a-b);for(const k in t)t[k].sort((a,b)=>a-b);
    self.postMessage({type:"built",charIndex:c,tokenIndex:t});}`;
  const worker=new Worker(URL.createObjectURL(new Blob([workerSrc],{type:"text/javascript"})));
  worker.onmessage=(e)=>{if(e.data?.type==="built"){charIndex=e.data.charIndex||{};tokenIndex=e.data.tokenIndex||{};ready=true; renderLazyByCategory(rows); loading.style.display="none";}};

  (async function load(){
    loading.style.display="block";
    const resp = await fetch(DATA_URL + (DATA_URL.includes('?')?'&':'?') + 't=' + Date.now(), {cache:'no-cache', mode:'cors'});
    if(!resp.ok){ loading.style.display="none"; zero.style.display="block"; zero.textContent="CSV 로드 실패: "+resp.status; console.error("CSV 실패", resp.status, DATA_URL); return; }
    const csv = await resp.text();
    const parsed = Papa.parse(csv,{header:true,skipEmptyLines:true});

    const normRow = row => { const o={}; for(const k in row){ o[String(k||"").trim().toLowerCase()] = row[k]; } return o; };
    const data = parsed.data.map(normRow);
    if(!data.length){ loading.style.display="none"; zero.style.display="block"; zero.textContent="CSV가 비어있습니다."; return; }

    const headers = Object.keys(data[0]||{});
    const expandVariants=(bases)=>{ const B=bases.map(x=>x.toLowerCase()); return headers.filter(h=>B.some(b=>h===b||h.startsWith(b+"_"))); };
    const EXPANDED_SAFE_FIELDS = expandVariants(SAFE_FIELDS_BASE);
    const nameCandidatesFor=base=>[`${base}_manual_alt`,`${base}_alt`,`${base}_manual`,base];
    const NAME_FIELDS_ALL=NAME_FIELDS_BASE.flatMap(nameCandidatesFor);
    const TOKEN_AUX_FIELDS=["name_en","name_en_alt","name_en_manual","name_en_manual_alt"].filter(f=>headers.includes(f));

    rows = data.map(r=>{
      const name=(NAME_FIELDS_ALL.find(f=>r[f]) && NAME_FIELDS_ALL.map(f=>r[f]).find(Boolean)) || r["name_en"] || "";
      const safeStrings=[...EXPANDED_SAFE_FIELDS.map(f=>r[f]||""), ...TOKEN_AUX_FIELDS.map(f=>r[f]||"")].join(",");
      const idxStr=toLower(safeStrings);
      const idxChars=idxStr;
      const idxLatinTokens=uniq(splitLatin(idxStr));
      const safeKo=r["keywords_ko_safe"] || r["keywords_ko_safe_alt"] || "";
      return { id:r.id, category:r.category||"", code:(r.code||"").toLowerCase(), emoji:r.emoji||"", name, name_en:r["name_en"]||"", idxChars, idxLatinTokens, safeKo };
    });

    worker.postMessage({type:"build", data:rows.map((r,i)=>({i,idxChars:r.idxChars,idxLatinTokens:r.idxLatinTokens}))});
  })();

  /* ===== 5) 검색 ===== */
  const $q=document.getElementById("q"), $list=document.getElementById("list"), $zero=document.getElementById("zero"); let t;
  $q.addEventListener("input",()=>{ clearTimeout(t); t=setTimeout(runSearch,160); });

  function unionArrays(arrs){ const s=new Set(); for(const a of arrs){ if(!a) continue; for(const v of a) s.add(v); } return [...s]; }

  function runSearch(){
    if(!ready) return;
    const qRaw=$q.value||"", q=toLower(qRaw.trim());
    if(!q){ document.body.classList.remove("searching"); renderLazyByCategory(rows); return; }
    document.body.classList.add("searching");

    const latin=isLatin(q);
    const chars=latin?[]:uniq(q.split("").filter(Boolean));
    const tokens=latin?uniq(q.split(/[\s,]+/).map(toLower).filter(Boolean)):[];
    let candidateIdxs;
    if(!latin){ const lists=chars.map(ch=>charIndex[ch]); candidateIdxs=unionArrays(lists); }
    else{ const lists=tokens.map(t=>tokenIndex[t]); candidateIdxs=unionArrays(lists); }
    if(!candidateIdxs.length){ $list.innerHTML=""; $zero.style.display="block"; return; }

    const hits=[];
    for(const i of candidateIdxs){
      const r=rows[i]; if(!r) continue; let score=0, matched=false;
      if(!latin){
        for(const ch of chars){ if(r.idxChars.includes(ch)){ matched=true; score+=SCORE.tokenHit; } }
        for(const ch of chars){ if(toLower(r.name).includes(ch)){ score+=SCORE.nameHit; matched=true; } }
      }else{
        for(const tkn of tokens){
          if(r.idxLatinTokens.includes(tkn)||toLower(r.name_en).includes(tkn)||toLower(r.name).includes(tkn)){
            matched=true; score+=SCORE.tokenHit; if(toLower(r.name).includes(tkn)) score+=SCORE.nameHit;
          }
        }
      }
      for(const key of (latin?tokens:chars)){ if(toLower(r.category).includes(key)) score+=SCORE.categoryHit; }
      if(matched) hits.push({r,score});
    }
    hits.sort((a,b)=>b.score-a.score);
    renderAllGrouped(hits.slice(0,MAX_RESULTS).map(x=>x.r), q);
  }

  /* ===== 6) 렌더링: 온디맨드 & 전체 ===== */
  function groupBy(items, keyFn){ const m=new Map(); for(const it of items){ const k=keyFn(it)||"Uncategorized"; if(!m.has(k)) m.set(k,[]); m.get(k).push(it);} return m; }
  const observers=[];

  function renderLazyByCategory(items){
    // 기존 옵저버 모두 해제
    observers.forEach(o=>o.disconnect()); observers.length=0;
    $list.innerHTML=""; $zero.style.display="none";
    const groups=Array.from(groupBy(items,r=>r.category).entries());

    // 섹션 프레임만 만들고, 첫 N개는 즉시 렌더
    groups.forEach(([cat,arr],idx)=>{
      const sec=document.createElement("section"); sec.className="sec lazy";
      sec.innerHTML=`<div class="cat">${esc(cat)} <span class="cnt">${arr.length}</span></div><div class="emojis"></div>`;
      const grid=sec.querySelector(".emojis");
      $list.appendChild(sec);

      const renderSection=()=>{
        if(sec.dataset.rendered) return;
        sec.dataset.rendered="1";
        let start=0;
        function renderChunk(){
          const end=Math.min(start+EMOJI_CHUNK,arr.length);
          const slice=arr.slice(start,end);
          const inner=slice.map(r=>{
            const title=esc(r.name||"");
            return `<div class="e" data-emoji="${esc(r.emoji||'')}" data-code="${esc(r.code||'')}" title="${title}"><span class="glyph"></span></div>`;
          }).join("");
          const tmp=document.createElement("div"); tmp.innerHTML=inner; while(tmp.firstChild) grid.appendChild(tmp.firstChild);
          paintNewGlyphs(grid);
          start=end; if(start<arr.length) rIC(renderChunk);
        }
        renderChunk();
      };

      if(idx < ABOVE_FOLD_CATS) renderSection();
      else {
        const io=new IntersectionObserver((ents,obs)=>{ ents.forEach(e=>{ if(e.isIntersecting){ renderSection(); obs.unobserve(e.target);} }); }, {rootMargin:"1200px"});
        io.observe(sec); observers.push(io);
      }
    });
  }

  function renderAllGrouped(items, query=""){
    $list.innerHTML=""; $zero.style.display="none";
    const groups=Array.from(groupBy(items,r=>r.category).entries()); let catIdx=0;
    function next(){
      if(catIdx>=groups.length) return;
      const frag=document.createDocumentFragment();
      for(let k=0;k<1 && catIdx<groups.length;k++,catIdx++){
        const [cat,arr]=groups[catIdx];
        const sec=document.createElement("section"); sec.className="sec";
        sec.innerHTML=`<div class="cat">${esc(cat)} <span class="cnt">${arr.length}</span></div><div class="emojis"></div>`;
        const grid=sec.querySelector(".emojis");
        let start=0;
        function chunk(){
          const end=Math.min(start+EMOJI_CHUNK,arr.length);
          const slice=arr.slice(start,end);
          const inner=slice.map(r=>{
            const title=esc(r.name||"");
            const nm=query?`<div class="nm">${esc(r.name||"")}</div>`:"";
            return `<div class="e" data-emoji="${esc(r.emoji||'')}" data-code="${esc(r.code||'')}" title="${title}"><span class="glyph"></span>${nm}</div>`;
          }).join("");
          const tmp=document.createElement("div"); tmp.innerHTML=inner; while(tmp.firstChild) grid.appendChild(tmp.firstChild);
          paintNewGlyphs(grid);
          start=end; if(start<arr.length) rIC(chunk);
        }
        chunk(); frag.appendChild(sec);
      }
      $list.appendChild(frag); if(catIdx<groups.length) rIC(next);
    }
    next();
  }

  /* ===== 7) 클릭 → 복사 + 복사칩 컬러 ===== */
  const copybar=document.getElementById("copybar");
  document.addEventListener("click",async ev=>{
    const tile=ev.target.closest(".e"); if(!tile) return;
    const emoji=tile.getAttribute("data-emoji")||"", code=tile.getAttribute("data-code")||"";
    try{ await navigator.clipboard.writeText(emoji||''); }catch(e){}
    const chip=document.createElement("span"); chip.className="copyglyph";
    // 동일 폴백 로직으로 칠한다(배경)
    paintGlyphEl(chip, code, emoji);
    copybar.appendChild(chip);
  });

  /* ===== 8) SW 등록 ===== */
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(()=>{}); }
  </script>
</body>
</html>
