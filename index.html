<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emoji Search — Pro (SAFE-only)</title>
  <style>
    :root{--gap:14px;}
    body{font-family:system-ui,apple sd gothic neo,Segoe UI,Roboto,Helvetica,Arial;
         margin:24px;color:#222;}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .search{flex:1;min-width:260px;max-width:640px;padding:12px 16px;font-size:18px;
            border:1px solid #ddd;border-radius:12px;outline:none}
    .hint{color:#666;font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(180px,1fr));gap:var(--gap);}
    .card{border:1px solid #eee;border-radius:12px;padding:12px 14px;background:#fff}
    .emoji{font-size:36px;line-height:1;margin-bottom:6px}
    .name{font-weight:700;margin:2px 0 6px}
    .meta{color:#666;font-size:12px}
    mark{background:#fff2a8;padding:0 .5px;border-radius:2px}
    .zero{margin-top:16px;color:#666}
  </style>
</head>
<body>
  <div class="toolbar">
    <input id="q" class="search" placeholder="검색: 하트 / ㅋㅋ / 草 / ok … (CJK은 글자 1개라도 겹치면 노출)">
    <span class="hint">SAFE 전용 매칭 · 밈 제외 · 경량 점수화</span>
  </div>
  <div id="list" class="grid"></div>
  <div id="zero" class="zero" style="display:none;">결과가 없습니다. 철자/언어를 바꿔보세요.</div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
  /** ====== 설정 ====== */
  // 1) CSV 경로
  const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_RAfp9VnhQCpOkq9fBnu3b44r6jTB9EyT4qefGNSOf7R0SKuvEt_OvFs_qHLFQA9a3VRade4mxsjA/pub?gid=813614977&single=true&output=csv";

  // 2) 카드에 보여줄 이름 우선순위(앞에서부터 우선)
  const NAME_FIELDS = ["name_ko","name_ja","name_zh-CN","name_en"];

  // 3) SAFE 인덱스에 포함할 필드(밈/ALL 금지)
  const SAFE_FIELDS = [
    "keywords_ko_safe","keywords_ja_safe","keywords_zh-CN_safe",
    "keywords_es_safe","keywords_pt_safe","keywords_fr_safe",
    "keywords_tr_safe","keywords_id_safe","keywords_ru_safe","keywords_ar_safe",
    "name_en" // 라틴 검색 보조용
  ];

  // 4) 검색/정렬 파라미터
  const MAX_RESULTS = 400;            // 최대 노출
  const SCORE = { nameHit: 3, tokenHit: 1, categoryHit: 0.5 }; // 가중치

  /** ====== 유틸 ====== */
  const rmDiacritics = s => (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  const toLower = s => rmDiacritics(String(s||"")).toLowerCase();
  const splitLatin = s => toLower(s).split(/[^a-z0-9]+/).filter(t=>t.length>1);
  const uniq = arr => [...new Set(arr)];
  const hasCJK = s => /[\uac00-\ud7a3\u3040-\u30ff\u4e00-\u9fff]/.test(s);

  /** ====== 데이터 로드 ====== */
  let rows = [];
  let ready = false;

  Papa.parse(DATA_URL, {
    download:true, header:true, skipEmptyLines:true,
    complete: (res) => {
      rows = res.data.map(r => {
        // 표시 이름 결정
        const name = NAME_FIELDS.map(f=>r[f]).find(Boolean) || r.name_en || "";
        // SAFE 인덱스(문자열+라틴 토큰)
        const safeStrings = SAFE_FIELDS.map(f => r[f]||"").join(",");
        const idxStr = toLower(safeStrings);
        const idxCJK = idxStr;               // CJK는 문자열 포함 검사
        const idxLatinTokens = uniq(splitLatin(idxStr)); // 라틴은 토큰 배열
        return {
          id: r.id, category: r.category||"", code: r.code||"", emoji: r.emoji||"",
          // 표시
          name, name_en: r.name_en||"",
          // 검색 인덱스
          idxCJK, idxLatinTokens,
          // 하이라이트를 위한 원본 SAFE(대표 한 언어만 보여줄 때는 교체 가능)
          safeKo: r.keywords_ko_safe || ""
        };
      });
      ready = true;
      render(rows.slice(0, 120));
    }
  });

  /** ====== 검색 ====== */
  const $q = document.getElementById("q");
  const $list = document.getElementById("list");
  const $zero = document.getElementById("zero");
  let t;

  $q.addEventListener("input", () => {
    clearTimeout(t);
    t = setTimeout(runSearch, 60);
  });

  function runSearch(){
    if(!ready){ return; }
    const qRaw = $q.value || "";
    const q = toLower(qRaw.trim());
    if(!q){
      render(rows.slice(0, 120));
      return;
    }
    const cjk = hasCJK(q);
    const hits = [];

    // 질의 전처리
    const chars = cjk ? uniq(q.split("").filter(Boolean)) : [];
    const tokens = cjk ? [] : uniq(q.split(/[\s,]+/).map(toLower).filter(Boolean));

    for(const r of rows){
      let score = 0;
      let matched = false;

      if(cjk){
        // 문자 1개라도 포함되면 매칭
        for(const ch of chars){
          if(r.idxCJK.includes(ch)){
            matched = true;
            score += SCORE.tokenHit;
          }
        }
        // 이름에 포함되면 가중치 추가
        for(const ch of chars){
          if(toLower(r.name).includes(ch)) score += SCORE.nameHit;
        }
      }else{
        // 라틴: 토큰(부분문자열) OR
        for(const t of tokens){
          if(r.idxLatinTokens.includes(t) || toLower(r.name_en).includes(t) || toLower(r.name).includes(t)){
            matched = true;
            score += SCORE.tokenHit;
            if(toLower(r.name).includes(t)) score += SCORE.nameHit;
          }
        }
      }

      // 카테고리 보너스(원하면 키워드화)
      for(const key of (cjk ? chars : tokens)){
        if(toLower(r.category).includes(key)) score += SCORE.categoryHit;
      }

      if(matched){
        hits.push({r, score});
      }
    }

    // 점수 정렬 → 상위만 노출
    hits.sort((a,b)=> b.score - a.score);
    render(hits.slice(0, MAX_RESULTS).map(x=>x.r));
  }

  /** ====== 렌더 & 하이라이트 ====== */
  function esc(s){return (s||"").replace(/[&<>"]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]));}

  function highlight(text, query){
    if(!query) return esc(text);
    const q = toLower(query);
    if(hasCJK(q)){
      // 문자 집합으로 하이라이트
      const set = new Set(q.split(""));
      let out = "";
      for(const ch of text){
        if(set.has(toLower(ch))) out += "<mark>"+esc(ch)+"</mark>";
        else out += esc(ch);
      }
      return out;
    }else{
      // 라틴: 토큰 OR
      const tokens = uniq(q.split(/[\s,]+/).filter(Boolean)).sort((a,b)=>b.length-a.length);
      let html = esc(text);
      for(const t of tokens){
        if(!t) continue;
        const re = new RegExp("("+t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")","ig");
        html = html.replace(re, "<mark>$1</mark>");
      }
      return html;
    }
  }

  function render(items){
    if(!items.length){
      $list.innerHTML = "";
      $zero.style.display = "block";
      return;
    }
    $zero.style.display = "none";
    const q = $q.value || "";
    $list.innerHTML = items.map(r => `
      <div class="card">
        <div class="emoji">${r.emoji || "⬜"}</div>
        <div class="name">${highlight(r.name, q)}</div>
        <div class="meta">${esc(r.category)} · ${esc(r.code)}</div>
        ${r.safeKo ? `<div class="meta">${highlight(r.safeKo, q)}</div>` : ""}
      </div>
    `).join("");
  }
  </script>
</body>
</html>
