<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>í”„ë¡œ ì´ëª¨ì§€ ê²€ìƒ‰ â€” ì¹´í…Œê³ ë¦¬ ì „ë¶€ ë³´ê¸° (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ë™)</title>

  <!-- ì„±ëŠ¥: ë„¤íŠ¸ì›Œí¬ ì´ˆë°˜ ì˜ì  ì¡°ì¤€ -->
  <link rel="preconnect" href="https://docs.google.com" crossorigin>
  <link rel="preconnect" href="https://lh3.googleusercontent.com" crossorigin>
  <link rel="dns-prefetch" href="//docs.google.com">
  <link rel="dns-prefetch" href="//lh3.googleusercontent.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <style>
    :root{
      --maxw: 1100px;
      --grid-width: 980px;     /* ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ ìµœëŒ€ í­ */
      --tile: 72px;            /* íƒ€ì¼ í¬ê¸° */
      --gap: 8px;              /* íƒ€ì¼ ê°„ê²© */
      --chip-h: 36px;          /* ìƒë‹¨ ì¹´í…Œê³ ë¦¬ ì¹© ë†’ì´ */
      --brand: #111;
      --border: #eee;
    }
    *{ box-sizing: border-box }
    html, body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple Color Emoji,Noto Color Emoji,sans-serif; }

    /* ìƒë‹¨ íˆ´ë°” */
    #toolbar{ position: sticky; top: 0; z-index: 10; background: #fff; border-bottom: 1px solid var(--border); }
    #toolbar .in{ max-width: var(--maxw); margin: 0 auto; padding: 10px 12px; display: grid; gap: 8px; grid-template-columns: 1fr auto; align-items: center; }
    #search{ height: 40px; border: 1px solid #ddd; border-radius: 10px; padding: 0 12px; font-size: 15px; }
    #copyBox{ display: flex; gap: 8px; align-items: center; }
    #copyOut{ width: 180px; height: 40px; border: 1px solid #ddd; border-radius: 10px; padding: 0 12px; font-size: 15px; }
    #btnCopy{ height: 40px; padding: 0 14px; border: 1px solid var(--brand); background: var(--brand); color:#fff; border-radius: 10px; cursor: pointer; }

    /* ì¹´í…Œê³ ë¦¬ ì¹© */
    #chipsWrap{ background:#fff; border-bottom:1px solid var(--border); }
    #chips{ max-width: var(--maxw); margin: 0 auto; padding: 8px 12px; display: grid; grid-auto-flow: column; grid-auto-columns: max-content; gap: 8px; overflow-x: auto; }
    .chip{ height: var(--chip-h); padding:0 12px; display: inline-grid; grid-auto-flow: column; gap: 8px; align-items: center; border: 1px solid #ddd; border-radius: 999px; background:#fff; cursor:pointer; white-space:nowrap; }
    .chip .emo{ font-size: 18px; line-height: 1; }
    .chip.active{ background:#f5f6ff; border-color:#d7dcff; }

    /* ìƒíƒœ/ì•Œë¦¼ */
    #status{ max-width: var(--maxw); margin: 10px auto 0; padding: 6px 12px; color:#555; text-align:center; display:none; }
    #toast{ position:fixed; left:50%; bottom:22px; transform:translateX(-50%); z-index:20; background:rgba(0,0,0,.85); color:#fff; padding:8px 12px; border-radius:20px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .18s; }
    #toast.show{ opacity:1; }

    /* ê²€ìƒ‰ ê²°ê³¼ */
    #resultWrap{ max-width: var(--grid-width); margin: 14px auto 0; padding: 0 8px; display:none; }
    #resultHead{ display:flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
    #resultGrid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(var(--tile), 1fr)); gap: var(--gap); }

    /* ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ (content-visibilityë¡œ ì´ˆê¸° ë¶€ë‹´ ìµœì†Œí™”) */
    .cat-section{ max-width: var(--grid-width); margin: 18px auto 44px; padding: 0 8px; content-visibility: auto; contain-intrinsic-size: 1px 1200px; }
    .cat-head{ display:flex; gap:10px; align-items:center; margin-bottom: 8px; }
    .cat-emo{ font-size:22px; }
    .cat-title{ font-size:18px; font-weight:600; }
    .cat-count{ font-size:13px; color:#666; margin-left:auto; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(var(--tile), 1fr)); gap: var(--gap); }
    .tile{ width:var(--tile); height:var(--tile); display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:10px; background:#fff; user-select:none; cursor:pointer; transition:transform .04s }
    .tile:hover{ transform: translateY(-1px); background:#fafafa; }
    .tile img{ width:var(--tile); height:var(--tile); image-rendering:-webkit-optimize-contrast; }

    .more{ margin-top: 10px; text-align:center; }
    .btn-more{ width:100%; height:42px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer; }
    .btn-more[disabled]{ opacity:.6; cursor:default; }

    /* ë²•ì  í‘œê¸° */
    #legal{ max-width:var(--maxw); margin: 28px auto 40px; padding: 0 12px; font-size:12px; color:#777; }
    #legal a{ color: inherit; text-decoration: underline; }

    @media (max-width: 768px){
      :root{ --grid-width: 560px; }
      #chips{ grid-auto-columns: max-content; }
    }
  </style>

  <!-- Twemoji: ì»¬ëŸ¬ PNG (SVG OFF). íŒŒì‹±ì€ ì„¹ì…˜ ê°€ì‹œí™” ì‹œì ì—ë§Œ ìˆ˜í–‰. -->
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <!-- 1) ìƒë‹¨ -->
  <header id="toolbar">
    <div class="in">
      <input id="search" type="search" placeholder="ì´ëª¨ì§€ ì´ë¦„(name_*) / í‚¤ì›Œë“œ ê²€ìƒ‰ (í•œ ê¸€ìë„ ë§¤ì¹­)"/>
      <div id="copyBox">
        <input id="copyOut" type="text" readonly placeholder="ë³µì‚¬í•  ì´ëª¨ì§€"/>
        <button id="btnCopy" type="button">ë³µì‚¬</button>
      </div>
    </div>
  </header>

  <!-- 2) ì¹´í…Œê³ ë¦¬ ì¹© -->
  <div id="chipsWrap"><div id="chips"></div></div>

  <!-- 3) ìƒíƒœ/í† ìŠ¤íŠ¸ -->
  <div id="status"></div>
  <div id="toast">ë³µì‚¬ ì™„ë£Œ!</div>

  <!-- 4) ê²€ìƒ‰ ê²°ê³¼ -->
  <section id="resultWrap">
    <div id="resultHead"><div id="resultTitle">ê²€ìƒ‰ ê²°ê³¼</div><div id="resultCount"></div></div>
    <div id="resultGrid"></div>
  </section>

  <!-- 5) ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ë“¤ì´ ì—¬ê¸°ì— ë§Œë“¤ì–´ì§ -->
  <div id="sections"></div>

  <!-- 6) ë²•ì  í‘œê¸° -->
  <footer id="legal">
    Emoji graphics by <a href="https://twemoji.twitter.com/" target="_blank" rel="noopener">Twemoji</a> Â© Twitter,
    licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0</a>. Unicode data Â© The Unicode Consortium.
  </footer>

  <script type="module">
>
    /* =========================================================
       ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²°: ë¬¸ì„œID + gid (ë‘ëª©ë‹˜ URL ë°˜ì˜)
       - ë°˜ë“œì‹œ "ì›¹ì— ê²Œì‹œ(Publish to the web)" ìƒíƒœì—¬ì•¼ í•¨
    ========================================================= */
    const GSHEET = {
      id:  '1-W_w24LxJGwqpsSW1B8pqCQGMWF_TV-Ip5L5XqDG68Q',
      gid: '1543598799',           // sheetName ëŒ€ì‹  gid ì‚¬ìš©(ì•ˆì •)
      query: 'select *'
    };

    /* =========================================================
       íŒŒë¼ë¯¸í„° / ë¼ë²¨
    ========================================================= */
    const INITIAL_PER_CAT = 36;     // ê° ì¹´í…Œê³ ë¦¬ ì²« ë…¸ì¶œ ìˆ˜
    const MORE_CHUNK      = 240;    // ë”ë³´ê¸° ë‹¹ ë¶™ì¼ ìˆ˜
    const CAT_ORDER = [
      "Smileys & Emotion","People & Body","Animals & Nature","Food & Drink",
      "Travel & Places","Activities","Objects","Symbols","Flags"
    ];
    const LOCALE = (navigator.language||'en').toLowerCase().split('-')[0]; // ko,en,ja,zh...
    const LABELS = {
      en: { "Smileys & Emotion":"Smileys & Emotion","People & Body":"People & Body","Animals & Nature":"Animals & Nature","Food & Drink":"Food & Drink","Travel & Places":"Travel & Places","Activities":"Activities","Objects":"Objects","Symbols":"Symbols","Flags":"Flags" },
      ko: { "Smileys & Emotion":"ìŠ¤ë§ˆì¼/ê°ì •","People & Body":"í”¼í”Œ/ë°”ë””","Animals & Nature":"ë™ë¬¼/ìì—°","Food & Drink":"ìŒì‹/ìŒë£Œ","Travel & Places":"ì—¬í–‰/ì¥ì†Œ","Activities":"í™œë™","Objects":"ì‚¬ë¬¼","Symbols":"ê¸°í˜¸","Flags":"êµ­ê¸°" },
      ja: { "Smileys & Emotion":"ã‚¹ãƒã‚¤ãƒ«/æ„Ÿæƒ…","People & Body":"äºº/ä½“","Animals & Nature":"å‹•ç‰©/è‡ªç„¶","Food & Drink":"é£Ÿã¹ç‰©/é£²ã¿ç‰©","Travel & Places":"æ—…è¡Œ/å ´æ‰€","Activities":"æ´»å‹•","Objects":"ç‰©","Symbols":"è¨˜å·","Flags":"æ——" },
      zh: { "Smileys & Emotion":"è¡¨æƒ…/æƒ…æ„Ÿ","People & Body":"äººç‰©/èº«ä½“","Animals & Nature":"åŠ¨ç‰©/è‡ªç„¶","Food & Drink":"é£Ÿç‰©/é¥®æ–™","Travel & Places":"æ—…è¡Œ/åœ°ç‚¹","Activities":"æ´»åŠ¨","Objects":"ç‰©å“","Symbols":"ç¬¦å·","Flags":"æ——å¸œ" }
    };
    const L10N = LABELS[LOCALE] || LABELS.en;

    /* =========================================================
       DOM ì°¸ì¡°
    ========================================================= */
    const UI = {
      search:   document.getElementById('search'),
      copyOut:  document.getElementById('copyOut'),
      btnCopy:  document.getElementById('btnCopy'),
      chips:    document.getElementById('chips'),
      sections: document.getElementById('sections'),
      status:   document.getElementById('status'),
      toast:    document.getElementById('toast'),
      resultWrap:  document.getElementById('resultWrap'),
      resultTitle: document.getElementById('resultTitle'),
      resultCount: document.getElementById('resultCount'),
      resultGrid:  document.getElementById('resul

    /* =========================================================
       ë™ì‘ íŒŒë¼ë¯¸í„°
    ========================================================= */
    const INITIAL_PER_CAT = 36;             // ê° ì¹´í…Œê³ ë¦¬ ì²« í™”ë©´ í‘œì‹œ ìˆ˜
    const MORE_CHUNK = 240;                 // ë”ë³´ê¸° ì‹œ í•œ ë²ˆì— ë¶™ì¼ ì–‘
    const CAT_ORDER = [
      "Smileys & Emotion","People & Body","Animals & Nature","Food & Drink",
      "Travel & Places","Activities","Objects","Symbols","Flags"
    ];
    const LOCALE = (navigator.language||'en').toLowerCase().split('-')[0]; // 'ko','en','ja','zh','es' ë“±
    const LABELS = {
      "en": {
        "Smileys & Emotion":"Smileys & Emotion","People & Body":"People & Body","Animals & Nature":"Animals & Nature",
        "Food & Drink":"Food & Drink","Travel & Places":"Travel & Places","Activities":"Activities",
        "Objects":"Objects","Symbols":"Symbols","Flags":"Flags"
      },
      "ko": {
        "Smileys & Emotion":"ìŠ¤ë§ˆì¼/ê°ì •","People & Body":"í”¼í”Œ/ë°”ë””","Animals & Nature":"ë™ë¬¼/ìì—°",
        "Food & Drink":"ìŒì‹/ìŒë£Œ","Travel & Places":"ì—¬í–‰/ì¥ì†Œ","Activities":"í™œë™",
        "Objects":"ì‚¬ë¬¼","Symbols":"ê¸°í˜¸","Flags":"êµ­ê¸°"
      },
      "ja": {
        "Smileys & Emotion":"ã‚¹ãƒã‚¤ãƒ«/æ„Ÿæƒ…","People & Body":"äºº/ä½“","Animals & Nature":"å‹•ç‰©/è‡ªç„¶",
        "Food & Drink":"é£Ÿã¹ç‰©/é£²ã¿ç‰©","Travel & Places":"æ—…è¡Œ/å ´æ‰€","Activities":"æ´»å‹•",
        "Objects":"ç‰©","Symbols":"è¨˜å·","Flags":"æ——"
      },
      "zh": {
        "Smileys & Emotion":"è¡¨æƒ…/æƒ…æ„Ÿ","People & Body":"äººç‰©/èº«ä½“","Animals & Nature":"åŠ¨ç‰©/è‡ªç„¶",
        "Food & Drink":"é£Ÿç‰©/é¥®æ–™","Travel & Places":"æ—…è¡Œ/åœ°ç‚¹","Activities":"æ´»åŠ¨",
        "Objects":"ç‰©å“","Symbols":"ç¬¦å·","Flags":"æ——å¸œ"
      }
    };
    const L10N = LABELS[LOCALE] || LABELS.en;

    /* =========================================================
       DOM ì°¸ì¡°
    ========================================================= */
    const UI = {
      search:   document.getElementById('search'),
      copyOut:  document.getElementById('copyOut'),
      btnCopy:  document.getElementById('btnCopy'),
      chips:    document.getElementById('chips'),
      sections: document.getElementById('sections'),
      status:   document.getElementById('status'),
      toast:    document.getElementById('toast'),
      resultWrap: document.getElementById('resultWrap'),
      resultTitle: document.getElementById('resultTitle'),
      resultCount: document.getElementById('resultCount'),
      resultGrid:  document.getElementById('resultGrid'),
    };

    const showStatus = (m)=>{ UI.status.style.display='block'; UI.status.innerHTML=m; };
    const hideStatus = ()=>{ UI.status.style.display='none'; UI.status.textContent=''; };
    const toast = (t="ë³µì‚¬ ì™„ë£Œ!")=>{ UI.toast.textContent=t; UI.toast.classList.add('show'); setTimeout(()=>UI.toast.classList.remove('show'),900); };

    const twParse = (el)=> window.twemoji?.parse(el, {
      base:"https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/", folder:"72x72", ext:".png"
    });

    /* =========================================================
       ìœ í‹¸
    ========================================================= */
    const codeToEmoji = (code)=>{ try{ return String.fromCodePoint(...String(code).split('-').map(h=>parseInt(h,16))); }catch(_){ return "â“"; } };
    const lower = (s)=> String(s||'').toLowerCase();
    const pick = (obj, keys)=>{ for(const k of keys){ if(obj[k]!=null && obj[k]!=='') return obj[k]; const k2=Object.keys(obj).find(x=>x.toLowerCase()===k.toLowerCase()); if(k2 && obj[k2]!=null && obj[k2]!=='') return obj[k2]; } return ''; };

    /* =========================================================
       ë°ì´í„° ë¡œë”© (Google Sheets gviz JSON)
       - ì›¹ì— ê²Œì‹œ(Publish to web) ìƒíƒœì—¬ì•¼ í•¨
    ========================================================= */
    function gsheetUrl(){
      if(!GSHEET.id) return '';
      if(GSHEET.gid){
        return `https://docs.google.com/spreadsheets/d/${GSHEET.id}/gviz/tq?tqx=out:json&gid=${encodeURIComponent(GSHEET.gid)}&tq=${encodeURIComponent(GSHEET.query||'select *')}`;
      }
      return `https://docs.google.com/spreadsheets/d/${GSHEET.id}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(GSHEET.sheetName||'Sheet1')}&tq=${encodeURIComponent(GSHEET.query||'select *')}`;
    }
    async function fetchSheet(){
      const url = gsheetUrl();
      if(!url){ return []; }
      const r = await fetch(url, {cache:'no-cache'});
      const text = await r.text();
      // gviz ì‘ë‹µì€ JS ë˜í¼ë¡œ ê°ì‹¸ì ¸ ìˆìŒ â†’ JSONë§Œ ì¶”ì¶œ
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}')+1));
      const cols = (json.table.cols||[]).map(c=>c.label||c.id||'');
      const rows = (json.table.rows||[]).map(row=>{
        const obj={};
        (row.c||[]).forEach((cell,i)=>{ obj[cols[i]||('col'+i)] = cell ? (cell.f ?? cell.v ?? '') : ''; });
        return obj;
      });
      return rows;
    }

    /* =========================================================
       ì •ê·œí™”
       - í—ˆìš© ì»¬ëŸ¼ ì˜ˆì‹œ: group/category, emoji, code, name, name_ko, name_en, name_ja, name_zh, keywords
    ========================================================= */
    function normalize(rows){
      const out=[]; const seen=new Set();
      for(const r of rows){
        const group = pick(r, ['group','category','major','cat','section','type']);
        if(!group) continue;  // ê·¸ë£¹ ì—†ëŠ” í–‰ ìŠ¤í‚µ

        const emojiChar = pick(r, ['emoji','char']) || (pick(r,['code','unified','unicode','codepoint']) ? codeToEmoji(pick(r,['code','unified','unicode','codepoint'])) : '');
        if(!emojiChar) continue;

        const code = pick(r, ['code','unified','unicode','codepoint']).toUpperCase();
        const name_local =
          (LOCALE==='ko' && pick(r,['name_ko','ko','name-korean'])) ||
          (LOCALE==='ja' && pick(r,['name_ja','ja'])) ||
          (LOCALE==='zh' && pick(r,['name_zh','zh'])) ||
          pick(r,['name','name_en','label','cldr','short_name','id']) || '';

        const keywords = [ pick(r, ['keywords','tags','aliases','alias']) ].filter(Boolean).join(' ');
        const hay = [
          name_local,
          pick(r,['name','name_en','name_ko','name_ja','name_zh']),
          keywords,
          code
        ].join(' ').toLowerCase();

        const key = code || emojiChar;
        if(seen.has(key)) continue; seen.add(key);

        out.push({
          group,
          name: name_local || pick(r,['name','name_en']) || '',
          nameAll: hay,
          emoji: emojiChar,
          code,
        });
      }
      return out;
    }

    /* =========================================================
       ì „ì—­ ìƒíƒœ
    ========================================================= */
    let ALL=[], BY_CAT=new Map();   // ì¹´í…Œê³ ë¦¬ë³„ ë°°ì—´
    let VIEW_BY_CAT=new Map();      // í˜„ì¬ í™”ë©´ì— ë°˜ì˜ëœ ìƒíƒœ(ê²€ìƒ‰/ë”ë³´ê¸° ê³ ë ¤)
    let CHIP_INDEX=new Map();       // ì¹© â†’ ì„¹ì…˜ ìŠ¤í¬ë¡¤ ì—°ê²°

    /* =========================================================
       ë Œë”: ì¹©/ì„¹ì…˜/íƒ€ì¼
    ========================================================= */
    function buildChips(){
      UI.chips.innerHTML='';
      const frag=document.createDocumentFragment();
      const cats = [...BY_CAT.keys()].sort((a,b)=>(CAT_ORDER.indexOf(a)===-1?999:CAT_ORDER.indexOf(a))-(CAT_ORDER.indexOf(b)===-1?999:CAT_ORDER.indexOf(b)));
      for(const cat of cats){
        const btn=document.createElement('button'); btn.className='chip'; btn.dataset.cat=cat;
        const emo=document.createElement('span'); emo.className='emo'; emo.textContent = BY_CAT.get(cat)[0]?.emoji || 'ğŸ˜€';
        const lab=document.createElement('span'); lab.textContent = (L10N[cat] || cat);
        btn.append(emo, lab);
        btn.onclick=()=>{ document.getElementById(`sec-${slug(cat)}`)?.scrollIntoView({behavior:'smooth', block:'start'}); };
        frag.appendChild(btn);
      }
      UI.chips.appendChild(frag);
      // ì²« ì¹© í™œì„±í™”
      const first = cats[0]; if(first){ UI.chips.querySelector(`[data-cat="${cssEsc(first)}"]`)?.classList.add('active'); }
    }

    function buildSections(){
      UI.sections.innerHTML='';
      const cats = [...BY_CAT.keys()].sort((a,b)=>(CAT_ORDER.indexOf(a)===-1?999:CAT_ORDER.indexOf(a))-(CAT_ORDER.indexOf(b)===-1?999:CAT_ORDER.indexOf(b)));
      const frag=document.createDocumentFragment();
      for(const cat of cats){
        const sec=document.createElement('section'); sec.className='cat-section'; sec.id=`sec-${slug(cat)}`; sec.dataset.cat=cat;

        const head=document.createElement('div'); head.className='cat-head';
        const emo=document.createElement('span'); emo.className='cat-emo'; emo.textContent=BY_CAT.get(cat)[0]?.emoji || 'ğŸ˜€';
        const title=document.createElement('div'); title.className='cat-title'; title.textContent=(L10N[cat]||cat);
        const count=document.createElement('div'); count.className='cat-count'; count.id=`count-${slug(cat)}`;
        head.append(emo, title, count);

        const grid=document.createElement('div'); grid.className='grid'; grid.id=`grid-${slug(cat)}`;

        const more=document.createElement('div'); more.className='more';
        const btn=document.createElement('button'); btn.className='btn-more'; btn.textContent='ë”ë³´ê¸°';
        btn.id=`more-${slug(cat)}`; btn.onclick=()=>onMore(cat);
        more.appendChild(btn);

        sec.append(head, grid, more);
        frag.appendChild(sec);

        // ìµœì´ˆ 36ê°œë§Œ ë°˜ì˜
        const list=BY_CAT.get(cat)||[];
        VIEW_BY_CAT.set(cat, list.slice(0, INITIAL_PER_CAT));
        updateSection(cat);
      }
      UI.sections.appendChild(frag);

      // ì„¹ì…˜ì´ í™”ë©´ì— ë“¤ì–´ì˜¬ ë•Œë§Œ Twemoji íŒŒì‹±(ì„±ëŠ¥)
      const io=new IntersectionObserver((entries)=>{
        for(const e of entries){
          if(e.isIntersecting){ twParse(e.target); io.unobserve(e.target); }
        }
      },{rootMargin:"600px"});
      document.querySelectorAll('.cat-section').forEach(sec=>io.observe(sec));
    }

    function updateSection(cat){
      const grid=document.getElementById(`grid-${slug(cat)}`); if(!grid) return;
      const list = VIEW_BY_CAT.get(cat) || [];
      grid.innerHTML='';
      const frag=document.createDocumentFragment();
      for(const it of list){ frag.appendChild(makeTile(it)); }
      grid.appendChild(frag);

      const total = BY_CAT.get(cat)?.length || 0;
      const left = Math.max(0, total - list.length);
      document.getElementById(`count-${slug(cat)}`).textContent = `${list.length}/${total}`;
      const moreBtn=document.getElementById(`more-${slug(cat)}`);
      moreBtn.style.display = left>0 ? 'block' : 'none';
      moreBtn.disabled=false; moreBtn.textContent='ë”ë³´ê¸°';
    }

    function makeTile(it){
      const t=document.createElement('div'); t.className='tile'; t.title=it.name; t.dataset.emoji=it.emoji;
      // ì¼ë‹¨ ìˆœìˆ˜ í…ìŠ¤íŠ¸ ì´ëª¨ì§€ â†’ ì„¹ì…˜ ê°€ì‹œí™” ì‹œ íŠ¸ì›Œëª¨ì§€ë¡œ ì¹˜í™˜
      const span=document.createElement('span'); span.textContent=it.emoji; span.style.fontSize='40px'; t.appendChild(span);
      t.onclick=()=>{ UI.copyOut.value=it.emoji; copyToClipboard(it.emoji); };
      return t;
    }

    function onMore(cat){
      const list = BY_CAT.get(cat)||[];
      const cur  = VIEW_BY_CAT.get(cat)||[];
      if(cur.length >= list.length) return;
      const next = list.slice(0, Math.min(cur.length + MORE_CHUNK, list.length));
      VIEW_BY_CAT.set(cat, next);
      updateSection(cat);
    }

    /* =========================================================
       ê²€ìƒ‰: í•œ ê¸€ìë¼ë„ ë§¤ì¹­í•˜ë©´ ì „ì²´ì—ì„œ ê²€ìƒ‰
       - ê²°ê³¼ê°€ ìˆìœ¼ë©´ ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ ìˆ¨ê¹€, ê²°ê³¼ ì „ìš© ê·¸ë¦¬ë“œ í‘œì‹œ
    ========================================================= */
    function onSearch(){
      const q = lower(UI.search.value);
      if(!q){ UI.resultWrap.style.display='none'; // ì„¹ì…˜ í‘œì‹œ
        document.querySelectorAll('.cat-section').forEach(s=>s.style.display='block');
        return;
      }
      const hits=[];
      for(const arr of BY_CAT.values()){
        for(const it of arr){
          if( lower(it.nameAll).includes(q) ){ hits.push(it); }
        }
      }
      UI.resultTitle.textContent = `ê²€ìƒ‰ ê²°ê³¼`;
      UI.resultCount.textContent = `${hits.length.toLocaleString()}ê°œ`;
      UI.resultGrid.innerHTML='';
      const frag=document.createDocumentFragment();
      for(const it of hits){ frag.appendChild(makeTile(it)); }
      UI.resultGrid.appendChild(frag);
      UI.resultWrap.style.display='block';
      // ì¹´í…Œê³ ë¦¬ ì„¹ì…˜ì€ ì ‘ê¸°
      document.querySelectorAll('.cat-section').forEach(s=>s.style.display='none');
      // ê²°ê³¼ ê·¸ë¦¬ë“œì— ëŒ€í•´ì„œë§Œ íŠ¸ì›Œëª¨ì§€ íŒŒì‹±
      twParse(UI.resultGrid);
    }

    /* =========================================================
       í—¬í¼
    ========================================================= */
    function slug(s){ return String(s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,''); }
    function cssEsc(s){ return s.replace(/"/g,'\\"'); }
    async function copyToClipboard(text){
      try{ await navigator.clipboard.writeText(text); toast(); }
      catch(_){ UI.copyOut.value=text; UI.copyOut.select(); document.execCommand('copy'); toast(); }
    }

    /* =========================================================
       ë¶€íŠ¸ìŠ¤íŠ¸ë©
       - 1) ìºì‹œ ì¦‰ì‹œ ëœë” (localStorage)
       - 2) ìŠ¤í”„ë ˆë“œì‹œíŠ¸ fetch â†’ ìµœì‹  ë°˜ì˜
       â€» ìµœì´ˆ ë°©ë¬¸ì´ë¼ ìºì‹œê°€ ì—†ì–´ë„ gviz ì‘ë‹µì´ ì¼ë°˜ì ìœ¼ë¡œ ë¹¨ë¼ì„œ ì´ˆê¸° í™”ë©´ì´ ë¹ ë¦…ë‹ˆë‹¤.
    ========================================================= */
    const CACHE_KEY='emoji_db_v1';
    function loadCache(){
      try{
        const raw=localStorage.getItem(CACHE_KEY); if(!raw) return null;
        const obj=JSON.parse(raw); if(!Array.isArray(obj)) return null;
        return obj;
      }catch(_){ return null; }
    }
    function saveCache(arr){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify(arr)); }catch(_){ } }

    function rebuild(){
      // ì¹´í…Œê³ ë¦¬ ë§µ êµ¬ì„±
      BY_CAT.clear();
      for(const it of ALL){
        if(!BY_CAT.has(it.group)) BY_CAT.set(it.group, []);
        BY_CAT.get(it.group).push(it);
      }
      // ì¹´í…Œê³ ë¦¬ ì •ë ¬ & ë‚´ë¶€ ì •ë ¬
      for(const [k,arr] of BY_CAT.entries()){
        arr.sort((a,b)=> (a.name||'').localeCompare((b.name||''), LOCALE));
      }
      buildChips();
      buildSections();
      hideStatus();
    }

    (async function boot(){
      showStatus('ë°ì´í„° ë¡œë”© ì¤‘â€¦');

      // 1) ìºì‹œ ì¦‰ì‹œ ë°˜ì˜
      const cached = loadCache();
      if(cached && cached.length){
        ALL = cached;
        rebuild();
      }

      // 2) ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ìµœì‹  ë¡œë“œ
      try{
        const rows = await fetchSheet();
        const items = normalize(rows);
        if(items.length){
          ALL = items;
          saveCache(ALL);
          rebuild();
        }else if(!cached){
          showStatus('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
        }
      }catch(e){
        if(!cached) showStatus('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨. ê²Œì‹œ(Publish) ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.');
      }
    })();

    /* UI ì´ë²¤íŠ¸ */
    UI.search.addEventListener('input', onSearch);
    UI.btnCopy.addEventListener('click', ()=>{ const v=UI.copyOut.value||''; if(v) copyToClipboard(v); });

  </script>
</body>
</html>
