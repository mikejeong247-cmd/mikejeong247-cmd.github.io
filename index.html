<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>í”„ë¡œ ì´ëª¨ì§€ ê²€ìƒ‰ â€” í•˜ì´ë¸Œë¦¬ë“œ(ìŠ¤ë§ˆì¼ 32ê°œ ì¦‰ì‹œ)</title>

  <!-- ì„±ëŠ¥ í”„ë¦¬ì»¤ë„¥íŠ¸ -->
  <link rel="preconnect" href="https://docs.google.com" crossorigin>
  <link rel="dns-prefetch" href="//docs.google.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <style>
    :root{
      --maxw: 1100px;
      --grid-width: 980px;
      --tile: 72px;
      --gap: 8px;
      --chip-h: 36px;
      --brand: #111;
      --border: #eee;
    }
    *{ box-sizing: border-box }
    html, body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple Color Emoji,Noto Color Emoji,sans-serif }

    /* ìƒë‹¨ */
    #toolbar{ position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--border) }
    #toolbar .in{ max-width:var(--maxw); margin:0 auto; padding:10px 12px; display:grid; gap:8px; grid-template-columns:1fr auto; align-items:center }
    #search{ height:40px; border:1px solid #ddd; border-radius:10px; padding:0 12px; font-size:15px }
    #copyBox{ display:flex; gap:8px; align-items:center }
    #copyOut{ width:180px; height:40px; border:1px solid #ddd; border-radius:10px; padding:0 12px; font-size:15px }
    #btnCopy{ height:40px; padding:0 14px; border:1px solid var(--brand); background:var(--brand); color:#fff; border-radius:10px; cursor:pointer }

    /* ì¹© */
    #chipsWrap{ background:#fff; border-bottom:1px solid var(--border) }
    #chips{ max-width:var(--maxw); margin:0 auto; padding:8px 12px; display:grid; grid-auto-flow:column; grid-auto-columns:max-content; gap:8px; overflow-x:auto }
    .chip{ height:var(--chip-h); padding:0 12px; display:inline-grid; grid-auto-flow:column; gap:8px; align-items:center; border:1px solid #ddd; border-radius:999px; background:#fff; cursor:pointer; white-space:nowrap }
    .chip .emo{ font-size:18px; line-height:1 }
    .chip.active{ background:#f5f6ff; border-color:#d7dcff }

    /* ìƒíƒœ/í† ìŠ¤íŠ¸ */
    #status{ max-width:var(--maxw); margin:10px auto 0; padding:6px 12px; color:#555; text-align:center; display:none }
    #toast{ position:fixed; left:50%; bottom:22px; transform:translateX(-50%); z-index:20; background:rgba(0,0,0,.85); color:#fff; padding:8px 12px; border-radius:20px; font-size:14px; opacity:0; pointer-events:none; transition:opacity .18s }
    #toast.show{ opacity:1 }

    /* ê²€ìƒ‰ ê²°ê³¼ */
    #resultWrap{ max-width:var(--grid-width); margin:14px auto 0; padding:0 8px; display:none }
    #resultHead{ display:flex; justify-content:space-between; align-items:baseline; margin-bottom:8px }
    #resultGrid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(var(--tile),1fr)); gap:var(--gap) }

    /* ì„¹ì…˜ */
    .cat-section{ max-width:var(--grid-width); margin:18px auto 44px; padding:0 8px; }
    .cat-section.hidden{ display:none }
    .cat-head{ display:flex; gap:10px; align-items:center; margin-bottom:8px }
    .cat-emo{ font-size:22px }
    .cat-title{ font-size:18px; font-weight:600 }
    .cat-count{ font-size:13px; color:#666; margin-left:auto }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(var(--tile),1fr)); gap:var(--gap) }
    .tile{ width:var(--tile); height:var(--tile); display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--border); border-radius:10px; background:#fff; user-select:none; cursor:pointer; transition:transform .04s }
    .tile:hover{ transform:translateY(-1px); background:#fafafa }

    .more{ margin-top:10px; text-align:center }
    .btn-more{ width:100%; height:42px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer }
    .btn-more[disabled]{ opacity:.6; cursor:default }

    /* í‘¸í„° */
    #legal{ max-width:var(--maxw); margin:28px auto 40px; padding:0 12px; font-size:12px; color:#777 }
    #legal a{ color:inherit; text-decoration:underline }

    @media (max-width:768px){
      :root{ --grid-width:560px }
      #chips{ grid-auto-columns:max-content }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <!-- 1) ìƒë‹¨ -->
  <header id="toolbar">
    <div class="in">
      <input id="search" type="search" placeholder="ì´ëª¨ì§€ ì´ë¦„(name_*) / ë¶€ë¶„ ì¼ì¹˜ ê²€ìƒ‰ (í•œ ê¸€ìë„ ë§¤ì¹­)"/>
      <div id="copyBox">
        <input id="copyOut" type="text" readonly placeholder="ë³µì‚¬í•  ì´ëª¨ì§€"/>
        <button id="btnCopy" type="button">ë³µì‚¬</button>
      </div>
    </div>
  </header>

  <!-- 2) ì¹© -->
  <div id="chipsWrap"><div id="chips"></div></div>

  <!-- 3) ìƒíƒœ/í† ìŠ¤íŠ¸ -->
  <div id="status"></div>
  <div id="toast">ë³µì‚¬ ì™„ë£Œ!</div>

  <!-- 4) ê²€ìƒ‰ ê²°ê³¼ -->
  <section id="resultWrap">
    <div id="resultHead"><div id="resultTitle">ê²€ìƒ‰ ê²°ê³¼</div><div id="resultCount"></div></div>
    <div id="resultGrid"></div>
  </section>

  <!-- 5) ì„¹ì…˜ ì»¨í…Œì´ë„ˆ + í”„ë¦¬ë Œë”(ìŠ¤ë§ˆì¼/ê°ì • 32ê°œ) -->
  <div id="sections">
    <section class="cat-section" id="pre-smileys" data-cat="Smileys & Emotion">
      <div class="cat-head">
        <span class="cat-emo">ğŸ˜€</span>
        <div class="cat-title">ìŠ¤ë§ˆì¼/ê°ì •</div>
        <div class="cat-count" id="pre-count">32</div>
      </div>
      <div class="grid" id="pre-grid">
        <!-- 32ê°œ: data-emoji ì†ì„±ìœ¼ë¡œ ì¦‰ì‹œ ë³µì‚¬ ê°€ëŠ¥ -->
        <div class="tile" data-emoji="ğŸ˜€"><span style="font-size:40px">ğŸ˜€</span></div>
        <div class="tile" data-emoji="ğŸ˜ƒ"><span style="font-size:40px">ğŸ˜ƒ</span></div>
        <div class="tile" data-emoji="ğŸ˜„"><span style="font-size:40px">ğŸ˜„</span></div>
        <div class="tile" data-emoji="ğŸ˜"><span style="font-size:40px">ğŸ˜</span></div>
        <div class="tile" data-emoji="ğŸ˜†"><span style="font-size:40px">ğŸ˜†</span></div>
        <div class="tile" data-emoji="ğŸ˜…"><span style="font-size:40px">ğŸ˜…</span></div>
        <div class="tile" data-emoji="ğŸ˜‚"><span style="font-size:40px">ğŸ˜‚</span></div>
        <div class="tile" data-emoji="ğŸ¤£"><span style="font-size:40px">ğŸ¤£</span></div>
        <div class="tile" data-emoji="ğŸ™‚"><span style="font-size:40px">ğŸ™‚</span></div>
        <div class="tile" data-emoji="ğŸ™ƒ"><span style="font-size:40px">ğŸ™ƒ</span></div>
        <div class="tile" data-emoji="ğŸ˜‰"><span style="font-size:40px">ğŸ˜‰</span></div>
        <div class="tile" data-emoji="ğŸ˜Š"><span style="font-size:40px">ğŸ˜Š</span></div>
        <div class="tile" data-emoji="ğŸ˜‡"><span style="font-size:40px">ğŸ˜‡</span></div>
        <div class="tile" data-emoji="ğŸ¥°"><span style="font-size:40px">ğŸ¥°</span></div>
        <div class="tile" data-emoji="ğŸ˜"><span style="font-size:40px">ğŸ˜</span></div>
        <div class="tile" data-emoji="ğŸ¤©"><span style="font-size:40px">ğŸ¤©</span></div>
        <div class="tile" data-emoji="ğŸ˜˜"><span style="font-size:40px">ğŸ˜˜</span></div>
        <div class="tile" data-emoji="ğŸ˜—"><span style="font-size:40px">ğŸ˜—</span></div>
        <div class="tile" data-emoji="ğŸ˜™"><span style="font-size:40px">ğŸ˜™</span></div>
        <div class="tile" data-emoji="ğŸ˜š"><span style="font-size:40px">ğŸ˜š</span></div>
        <div class="tile" data-emoji="ğŸ˜‹"><span style="font-size:40px">ğŸ˜‹</span></div>
        <div class="tile" data-emoji="ğŸ˜›"><span style="font-size:40px">ğŸ˜›</span></div>
        <div class="tile" data-emoji="ğŸ˜œ"><span style="font-size:40px">ğŸ˜œ</span></div>
        <div class="tile" data-emoji="ğŸ¤ª"><span style="font-size:40px">ğŸ¤ª</span></div>
        <div class="tile" data-emoji="ğŸ˜"><span style="font-size:40px">ğŸ˜</span></div>
        <div class="tile" data-emoji="ğŸ¤‘"><span style="font-size:40px">ğŸ¤‘</span></div>
        <div class="tile" data-emoji="ğŸ¤—"><span style="font-size:40px">ğŸ¤—</span></div>
        <div class="tile" data-emoji="ğŸ¤­"><span style="font-size:40px">ğŸ¤­</span></div>
        <div class="tile" data-emoji="ğŸ¤«"><span style="font-size:40px">ğŸ¤«</span></div>
        <div class="tile" data-emoji="ğŸ¤”"><span style="font-size:40px">ğŸ¤”</span></div>
        <div class="tile" data-emoji="ğŸ¤¨"><span style="font-size:40px">ğŸ¤¨</span></div>
        <div class="tile" data-emoji="ğŸ« "><span style="font-size:40px">ğŸ« </span></div>
      </div>
      <div class="more">
        <button class="btn-more" id="pre-more">ë”ë³´ê¸°</button>
      </div>
    </section>
  </div>

  <!-- í‘¸í„° -->
  <footer id="legal">
    Emoji graphics by <a href="https://twemoji.twitter.com/" target="_blank" rel="noopener">Twemoji</a> Â© Twitter,
    licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">CC BY 4.0</a>. Unicode data Â© The Unicode Consortium.
  </footer>

  <!-- ì¸ë¼ì¸ JSON(ë™ì¼ 32ê°œ) : ë™ì  ë¹Œë“œìš© -->
  <script type="application/json" id="INLINE_SMILEYS">[
    {"group":"Smileys & Emotion","name_en":"grinning face","name_ko":"í™œì§ ì›ƒëŠ” ì–¼êµ´","emoji":"ğŸ˜€"},
    {"group":"Smileys & Emotion","name_en":"grinning face with big eyes","name_ko":"í™œì§ ì›ƒëŠ” ì–¼êµ´(ëˆˆ í¼)","emoji":"ğŸ˜ƒ"},
    {"group":"Smileys & Emotion","name_en":"grinning face with smiling eyes","name_ko":"ì›ƒëŠ” ì–¼êµ´(ëˆˆ ë¯¸ì†Œ)","emoji":"ğŸ˜„"},
    {"group":"Smileys & Emotion","name_en":"beaming face with smiling eyes","name_ko":"í™œì§ ë¯¸ì†Œ ëˆˆì›ƒìŒ","emoji":"ğŸ˜"},
    {"group":"Smileys & Emotion","name_en":"grinning squinting face","name_ko":"ì›ƒëŠ” ëˆˆ ì°¡ê·¸ë¦¼","emoji":"ğŸ˜†"},
    {"group":"Smileys & Emotion","name_en":"grinning face with sweat","name_ko":"ì‹ì€ë•€ ì›ƒìŒ","emoji":"ğŸ˜…"},
    {"group":"Smileys & Emotion","name_en":"face with tears of joy","name_ko":"ê¸°ì¨ì˜ ëˆˆë¬¼","emoji":"ğŸ˜‚"},
    {"group":"Smileys & Emotion","name_en":"rolling on the floor laughing","name_ko":"ë°êµ´ë°êµ´ ì›ƒìŒ","emoji":"ğŸ¤£"},
    {"group":"Smileys & Emotion","name_en":"slightly smiling face","name_ko":"ì˜…ì€ ë¯¸ì†Œ","emoji":"ğŸ™‚"},
    {"group":"Smileys & Emotion","name_en":"upside-down face","name_ko":"ê±°ê¾¸ë¡œ ì–¼êµ´","emoji":"ğŸ™ƒ"},
    {"group":"Smileys & Emotion","name_en":"winking face","name_ko":"ìœ™í¬","emoji":"ğŸ˜‰"},
    {"group":"Smileys & Emotion","name_en":"smiling face with smiling eyes","name_ko":"ëˆˆì›ƒìŒ ë¯¸ì†Œ","emoji":"ğŸ˜Š"},
    {"group":"Smileys & Emotion","name_en":"smiling face with halo","name_ko":"ì²œì‚¬ ë¯¸ì†Œ","emoji":"ğŸ˜‡"},
    {"group":"Smileys & Emotion","name_en":"smiling face with hearts","name_ko":"í•˜íŠ¸ ê°€ë“ ë¯¸ì†Œ","emoji":"ğŸ¥°"},
    {"group":"Smileys & Emotion","name_en":"smiling face with heart-eyes","name_ko":"í•˜íŠ¸ ëˆˆ ë¯¸ì†Œ","emoji":"ğŸ˜"},
    {"group":"Smileys & Emotion","name_en":"star-struck","name_ko":"ë³„ ë°˜í•œ ì–¼êµ´","emoji":"ğŸ¤©"},
    {"group":"Smileys & Emotion","name_en":"face blowing a kiss","name_ko":"ë½€ë½€","emoji":"ğŸ˜˜"},
    {"group":"Smileys & Emotion","name_en":"kissing face","name_ko":"í‚¤ìŠ¤ ì–¼êµ´","emoji":"ğŸ˜—"},
    {"group":"Smileys & Emotion","name_en":"kissing face with smiling eyes","name_ko":"ëˆˆì›ƒìŒ í‚¤ìŠ¤","emoji":"ğŸ˜™"},
    {"group":"Smileys & Emotion","name_en":"kissing face with closed eyes","name_ko":"ëˆˆê°ì€ í‚¤ìŠ¤","emoji":"ğŸ˜š"},
    {"group":"Smileys & Emotion","name_en":"face savoring food","name_ko":"ë§›ìˆì–´","emoji":"ğŸ˜‹"},
    {"group":"Smileys & Emotion","name_en":"face with tongue","name_ko":"ë©”ë¡±","emoji":"ğŸ˜›"},
    {"group":"Smileys & Emotion","name_en":"winking face with tongue","name_ko":"ìœ™í¬ ë©”ë¡±","emoji":"ğŸ˜œ"},
    {"group":"Smileys & Emotion","name_en":"zany face","name_ko":"ë¯¸ì¹œ ì²™","emoji":"ğŸ¤ª"},
    {"group":"Smileys & Emotion","name_en":"squinting face with tongue","name_ko":"ì°¡ê·¸ë¦° ë©”ë¡±","emoji":"ğŸ˜"},
    {"group":"Smileys & Emotion","name_en":"money-mouth face","name_ko":"ë¨¸ë‹ˆ ì–¼êµ´","emoji":"ğŸ¤‘"},
    {"group":"Smileys & Emotion","name_en":"hugging face","name_ko":"í¬ì˜¹","emoji":"ğŸ¤—"},
    {"group":"Smileys & Emotion","name_en":"face with hand over mouth","name_ko":"ì… ê°€ë¦¼","emoji":"ğŸ¤­"},
    {"group":"Smileys & Emotion","name_en":"shushing face","name_ko":"ì‰¿","emoji":"ğŸ¤«"},
    {"group":"Smileys & Emotion","name_en":"thinking face","name_ko":"ìƒê° ì¤‘","emoji":"ğŸ¤”"},
    {"group":"Smileys & Emotion","name_en":"face with raised eyebrow","name_ko":"ëˆˆì¹ ì¹˜ì¼œì˜¬ë¦¼","emoji":"ğŸ¤¨"},
    {"group":"Smileys & Emotion","name_en":"melting face","name_ko":"ë…¹ëŠ” ì–¼êµ´","emoji":"ğŸ« "}
  ]</script>

  <script type="module">
    /* =========================
       ì„¤ì •
    ========================== */
    const DATA_URL = (location.pathname.replace(/[^/]+$/, '') || '/') + 'data/build.json';
    const GSHEET = {  // ë‘ëª©ë‹˜ ìŠ¤í”„ë ˆë“œì‹œíŠ¸
      id : '1-W_w24LxJGwqpsSW1B8pqCQGMWF_TV-Ip5L5XqDG68Q',
      gid: '1543598799',
      query: 'select *'
    };
    const ACTIVE_PREF = "Smileys & Emotion";
    const INITIAL_PER_CAT = 32;
    const MORE_CHUNK      = 240;

    const CAT_ORDER = ["Smileys & Emotion","People & Body","Animals & Nature","Food & Drink","Travel & Places","Activities","Objects","Symbols","Flags"];
    const LOCALE = (navigator.language||'en').toLowerCase().split('-')[0];
    const LABELS = {
      en: {"Smileys & Emotion":"Smileys & Emotion","People & Body":"People & Body","Animals & Nature":"Animals & Nature","Food & Drink":"Food & Drink","Travel & Places":"Travel & Places","Activities":"Activities","Objects":"Objects","Symbols":"Symbols","Flags":"Flags"},
      ko: {"Smileys & Emotion":"ìŠ¤ë§ˆì¼/ê°ì •","People & Body":"í”¼í”Œ/ë°”ë””","Animals & Nature":"ë™ë¬¼/ìì—°","Food & Drink":"ìŒì‹/ìŒë£Œ","Travel & Places":"ì—¬í–‰/ì¥ì†Œ","Activities":"í™œë™","Objects":"ì‚¬ë¬¼","Symbols":"ê¸°í˜¸","Flags":"êµ­ê¸°"},
      ja: {"Smileys & Emotion":"ã‚¹ãƒã‚¤ãƒ«/æ„Ÿæƒ…","People & Body":"äºº/ä½“","Animals & Nature":"å‹•ç‰©/è‡ªç„¶","Food & Drink":"é£Ÿã¹ç‰©/é£²ã¿ç‰©","Travel & Places":"æ—…è¡Œ/å ´æ‰€","Activities":"æ´»å‹•","Objects":"ç‰©","Symbols":"è¨˜å·","Flags":"æ——"},
      zh: {"Smileys & Emotion":"è¡¨æƒ…/æƒ…æ„Ÿ","People & Body":"äººç‰©/èº«ä½“","Animals & Nature":"åŠ¨ç‰©/è‡ªç„¶","Food & Drink":"é£Ÿç‰©/é¥®æ–™","Travel & Places":"æ—…è¡Œ/åœ°ç‚¹","Activities":"æ´»åŠ¨","Objects":"ç‰©å“","Symbols":"ç¬¦å·","Flags":"æ——å¸œ"}
    };
    const L10N = LABELS[LOCALE] || LABELS.en;

    /* =========================
       DOM
    ========================== */
    const UI = {
      search:   document.getElementById('search'),
      copyOut:  document.getElementById('copyOut'),
      btnCopy:  document.getElementById('btnCopy'),
      chips:    document.getElementById('chips'),
      sections: document.getElementById('sections'),
      status:   document.getElementById('status'),
      toast:    document.getElementById('toast'),
      resultWrap:  document.getElementById('resultWrap'),
      resultTitle: document.getElementById('resultTitle'),
      resultCount: document.getElementById('resultCount'),
      resultGrid:  document.getElementById('resultGrid'),
      pre:       document.getElementById('pre-smileys'),
      preMore:   document.getElementById('pre-more')
    };
    const showStatus=(m)=>{ UI.status.style.display='block'; UI.status.innerHTML=m; };
    const hideStatus=()=>{ UI.status.style.display='none'; UI.status.textContent=''; };
    const toast=(t="ë³µì‚¬ ì™„ë£Œ!")=>{ UI.toast.textContent=t; UI.toast.classList.add('show'); setTimeout(()=>UI.toast.classList.remove('show'),900); };
    const twParse=(el)=> window.twemoji?.parse(el,{ base:"https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/", folder:"72x72", ext:".png" });

    /* =========================
       ìœ í‹¸
    ========================== */
    const lower = (s)=> String(s||'').toLowerCase();
    const codeToEmoji=(code)=>{ try{ return String.fromCodePoint(...String(code).split('-').map(h=>parseInt(h,16))); }catch(_){ return "â“"; } };
    const pick=(obj,keys)=>{ for(const k of keys){ if(obj[k]!=null && obj[k]!=='') return obj[k]; const k2=Object.keys(obj).find(x=>x.toLowerCase()===k.toLowerCase()); if(k2 && obj[k2]!=null && obj[k2]!=='') return obj[k2]; } return ''; };
    const slug=(s)=> String(s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');

    function fetchWithTimeout(url, ms=3000){
      return Promise.race([ fetch(url,{cache:'no-cache'}), new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms)) ]);
    }
    const gvizUrl=()=>`https://docs.google.com/spreadsheets/d/${GSHEET.id}/gviz/tq?tqx=out:json&gid=${encodeURIComponent(GSHEET.gid)}&tq=${encodeURIComponent(GSHEET.query||'select *')}`;

    /* =========================
       ì •ê·œí™”(name_*ë§Œ ê²€ìƒ‰)
    ========================== */
    function normalizeGeneric(root){
      const items = Array.isArray(root) ? root : (root.items||root.emojis||root.data||root.rows||[]);
      const out=[], seen=new Set();
      for(const r of items){
        if(!r) continue;
        const group = pick(r,['group','category','major','cat','section','type']);
        if(!group) continue;
        const code  = String(pick(r,['code','unified','unicode','codepoint'])||'').toUpperCase();
        const emoji = r.emoji || (code ? codeToEmoji(code) : '');
        if(!emoji) continue;
        const name_local =
          (LOCALE==='ko' && pick(r,['name_ko','ko'])) ||
          (LOCALE==='ja' && pick(r,['name_ja','ja'])) ||
          (LOCALE==='zh' && pick(r,['name_zh','zh'])) ||
          pick(r,['name','name_en','label','cldr','short_name']) || '';
        const names = Object.keys(r).filter(k=>/^name(_|-)/i.test(k) || k==='name').map(k=>String(r[k]||''));
        const hay = names.join(' ').toLowerCase();
        const key = code || emoji; if(seen.has(key)) continue; seen.add(key);
        out.push({ group, name:name_local||pick(r,['name','name_en'])||'', nameAll:hay, emoji, code });
      }
      return out;
    }

    async function loadDataURL(){
      try{ const r=await fetchWithTimeout(DATA_URL,2000); if(!r.ok) return null; return normalizeGeneric(await r.json()); }
      catch(_){ return null; }
    }
    async function loadSheet(){
      try{
        const r=await fetchWithTimeout(gvizUrl(),3500); const t=await r.text();
        const j=JSON.parse(t.substring(t.indexOf('{'), t.lastIndexOf('}')+1));
        const cols=(j.table.cols||[]).map(c=>c.label||c.id||'');
        const rows=(j.table.rows||[]).map(row=>{ const o={}; (row.c||[]).forEach((c,i)=>{ o[cols[i]||('col'+i)]=c?(c.f??c.v??''):''; }); return o; });
        return normalizeGeneric(rows);
      }catch(_){ return null; }
    }

    /* =========================
       ì „ì—­ ìƒíƒœ
    ========================== */
    let ALL=[], BY_CAT=new Map(), VIEW_BY_CAT=new Map();
    let ACTIVE_CAT=ACTIVE_PREF;
    const CACHE_KEY='emoji_db_v1';
    const saveCache=(arr)=>{ try{ localStorage.setItem(CACHE_KEY, JSON.stringify(arr)); }catch(_){ } };
    const loadCache=()=>{ try{ const raw=localStorage.getItem(CACHE_KEY); return raw?JSON.parse(raw):null; }catch(_){ return null; } };

    // ë°ì´í„° ë¡œë”© Promise (ì¹©/ë”ë³´ê¸°/ê²€ìƒ‰ì´ í˜¸ì¶œ ì‹œ ë³´ì¥)
    let dataLoadPromise=null;
    function ensureDataLoaded(){
      if(dataLoadPromise) return dataLoadPromise;
      dataLoadPromise = (async ()=>{
        // 1) /data/build.json
        let merged = await loadDataURL();
        // 2) gviz
        if(!merged || !merged.length) merged = await loadSheet();
        // 3) cache
        if(!merged || !merged.length){ const c=loadCache(); if(c && c.length) merged=c; }
        // 4) ì ìš©
        if(merged && merged.length){ ALL=merged; saveCache(ALL); rebuildFromALL(true); }
        return true;
      })();
      return dataLoadPromise;
    }

    /* =========================
       ë Œë”
    ========================== */
    const DEFAULT_EMO = {"Smileys & Emotion":"ğŸ˜€","People & Body":"ğŸ§‘","Animals & Nature":"ğŸ±","Food & Drink":"ğŸ”","Travel & Places":"âœˆï¸","Activities":"âš½","Objects":"ğŸ’¡","Symbols":"â™¾","Flags":"ğŸ‡°ğŸ‡·"};

    function buildChips(cats){
      UI.chips.innerHTML='';
      const f=document.createDocumentFragment();
      for(const cat of cats){
        const b=document.createElement('button'); b.className='chip'; b.dataset.cat=cat;
        const e=document.createElement('span'); e.className='emo'; e.textContent=(BY_CAT.get(cat)?.[0]?.emoji)||DEFAULT_EMO[cat]||'ğŸ˜€';
        const l=document.createElement('span'); l.textContent=(L10N[cat]||cat);
        b.append(e,l);
        b.onclick=async ()=>{
          if(!BY_CAT.get(cat)?.length){ await ensureDataLoaded(); }
          setActiveSection(cat);
        };
        f.appendChild(b);
      }
      UI.chips.appendChild(f);
      UI.chips.querySelectorAll('.chip').forEach(b=>b.classList.toggle('active', b.dataset.cat===ACTIVE_CAT));
    }

    function makeTile(it){
      const d=document.createElement('div'); d.className='tile'; d.title=it.name||it.code||''; d.dataset.emoji=it.emoji;
      const s=document.createElement('span'); s.textContent=it.emoji; s.style.fontSize='40px'; d.appendChild(s);
      d.onclick=()=>{ UI.copyOut.value=it.emoji; copyToClipboard(it.emoji); };
      return d;
    }

    function buildSections(cats){
      // í”„ë¦¬ë Œë” ì„¹ì…˜ êµì²´: ì „ì²´ ì„¹ì…˜ ì¬êµ¬ì„±
      UI.sections.innerHTML='';
      const f=document.createDocumentFragment();
      for(const cat of cats){
        const sec=document.createElement('section'); sec.className='cat-section'; sec.id=`sec-${slug(cat)}`; sec.dataset.cat=cat;

        const head=document.createElement('div'); head.className='cat-head';
        const emo=document.createElement('span'); emo.className='cat-emo'; emo.textContent=(BY_CAT.get(cat)?.[0]?.emoji)||DEFAULT_EMO[cat]||'ğŸ˜€';
        const title=document.createElement('div'); title.className='cat-title'; title.textContent=(L10N[cat]||cat);
        const count=document.createElement('div'); count.className='cat-count'; count.id=`count-${slug(cat)}`;
        head.append(emo,title,count);

        const grid=document.createElement('div'); grid.className='grid'; grid.id=`grid-${slug(cat)}`;

        const more=document.createElement('div'); more.className='more';
        const btn=document.createElement('button'); btn.className='btn-more'; btn.textContent='ë”ë³´ê¸°'; btn.id=`more-${slug(cat)}`;
        btn.onclick=()=>onMore(cat);
        more.appendChild(btn);

        sec.append(head,grid,more);
        f.appendChild(sec);

        // 32ê°œ ì´ˆê¸° ë Œë”
        const list=(BY_CAT.get(cat)||[]).slice(0,INITIAL_PER_CAT);
        VIEW_BY_CAT.set(cat,list);
        if(list.length){ const frag=document.createDocumentFragment(); list.forEach(it=>frag.appendChild(makeTile(it))); grid.appendChild(frag); }
        const total=BY_CAT.get(cat)?.length||0;
        count.textContent = total?`${list.length}/${total}`:'';
        btn.style.display = (total && list.length<total)?'block':'none';

        if(cat!==ACTIVE_CAT) sec.classList.add('hidden');
      }
      UI.sections.appendChild(f);
      const vis=document.getElementById(`sec-${slug(ACTIVE_CAT)}`); if(vis) twParse(vis);
    }

    function onMore(cat){
      const hasData = !!(BY_CAT.get(cat)?.length);
      const run = async ()=>{
        if(!hasData){ await ensureDataLoaded(); }
        const all = BY_CAT.get(cat)||[];
        const cur = VIEW_BY_CAT.get(cat)||[];
        const next = all.slice(0, Math.min(cur.length + MORE_CHUNK, all.length));
        VIEW_BY_CAT.set(cat,next);
        const grid=document.getElementById(`grid-${slug(cat)}`);
        grid.innerHTML='';
        const frag=document.createDocumentFragment(); next.forEach(it=>frag.appendChild(makeTile(it))); grid.appendChild(frag);
        document.getElementById(`count-${slug(cat)}`).textContent=`${next.length}/${all.length}`;
        const btn=document.getElementById(`more-${slug(cat)}`); btn.style.display = next.length<all.length?'block':'none';
        twParse(grid);
      };
      run();
    }

    function setActiveSection(cat){
      ACTIVE_CAT=cat;
      UI.chips.querySelectorAll('.chip').forEach(b=>b.classList.toggle('active', b.dataset.cat===ACTIVE_CAT));
      document.querySelectorAll('.cat-section').forEach(s=>s.classList.toggle('hidden', s.dataset.cat!==ACTIVE_CAT));
      const vis=document.getElementById(`sec-${slug(ACTIVE_CAT)}`); if(vis) twParse(vis);
    }

    function rebuildFromALL(focusKeep=false){
      // BY_CAT êµ¬ì„±
      BY_CAT.clear();
      for(const c of CAT_ORDER) BY_CAT.set(c, []);
      for(const it of ALL){ const g = BY_CAT.has(it.group)?it.group:it.group; if(!BY_CAT.has(g)) BY_CAT.set(g, []); BY_CAT.get(g).push(it); }
      for(const [k,arr] of BY_CAT.entries()){ arr.sort((a,b)=>(a.name||'').localeCompare(b.name||'', LOCALE)); }

      const cats=[...BY_CAT.keys()].sort((a,b)=>(CAT_ORDER.indexOf(a)===-1?999:CAT_ORDER.indexOf(a))-(CAT_ORDER.indexOf(b)===-1?999:CAT_ORDER.indexOf(b)));
      buildChips(cats);
      buildSections(cats);
      if(focusKeep) setActiveSection(ACTIVE_CAT);
      hideStatus();
    }

    /* =========================
       ë³µì‚¬/ê²€ìƒ‰
    ========================== */
    async function copyToClipboard(t){ try{ await navigator.clipboard.writeText(t); toast(); }catch(_){ UI.copyOut.value=t; UI.copyOut.select(); document.execCommand('copy'); toast(); } }
    UI.btnCopy.addEventListener('click', ()=>{ const v=UI.copyOut.value||''; if(v) copyToClipboard(v); });

    UI.search.addEventListener('input', async ()=>{
      const q = lower(UI.search.value);
      if(!q){
        UI.resultWrap.style.display='none';
        document.querySelectorAll('.cat-section').forEach(s=>s.classList.toggle('hidden', s.dataset.cat!==ACTIVE_CAT));
        const vis=document.getElementById(`sec-${slug(ACTIVE_CAT)}`); if(vis) twParse(vis);
        return;
      }
      // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¨¼ì € ë¡œë“œ
      if(!BY_CAT.size || ![...BY_CAT.values()].some(a=>a.length)) await ensureDataLoaded();
      const hits=[];
      for(const arr of BY_CAT.values()) for(const it of arr) if((it.nameAll||'').includes(q)) hits.push(it);
      UI.resultTitle.textContent='ê²€ìƒ‰ ê²°ê³¼'; UI.resultCount.textContent=`${hits.length.toLocaleString()}ê°œ`;
      UI.resultGrid.innerHTML=''; const frag=document.createDocumentFragment(); hits.forEach(it=>frag.appendChild(makeTile(it))); UI.resultGrid.appendChild(frag);
      UI.resultWrap.style.display='block';
      document.querySelectorAll('.cat-section').forEach(s=>s.classList.add('hidden'));
      twParse(UI.resultGrid);
    });

    /* =========================
       ë¶€íŠ¸ìŠ¤íŠ¸ë©
    ========================== */
    (function boot(){
      // í”„ë¦¬ë Œë” ì¦‰ì‹œ íŒŒì‹±(ì²« í™”ë©´ ì»¬ëŸ¬ ë³´ì¥)
      twParse(UI.pre);
      // í”„ë¦¬ë Œë” íƒ€ì¼ í´ë¦­ ë³µì‚¬
      UI.pre.addEventListener('click', (e)=>{
        const t=e.target.closest('.tile'); if(!t) return;
        const emo=t.dataset.emoji || t.textContent.trim(); UI.copyOut.value=emo; copyToClipboard(emo);
      });
      // í”„ë¦¬ë Œë” ë”ë³´ê¸°: ë°ì´í„° í™•ë³´ í›„ ìŠ¤ë§ˆì¼ í™•ì¥
      UI.preMore.addEventListener('click', async ()=>{
        await ensureDataLoaded();
        setActiveSection(ACTIVE_PREF);
        onMore(ACTIVE_PREF);
      });

      // ì¹©/ì„¹ì…˜ ë¼ˆëŒ€(ë°ì´í„° ì—†ì–´ë„ ì¹© ì „ë¶€ ë³´ì´ê²Œ)
      const EMPTY_MAP=new Map(CAT_ORDER.map(c=>[c,[]]));
      BY_CAT=EMPTY_MAP; buildChips(CAT_ORDER); setActiveSection(ACTIVE_PREF);

      // ë°±ê·¸ë¼ìš´ë“œ ë°ì´í„° ë¡œë“œ ì‹œì‘(ë„ì°© ì‹œ í”„ë¦¬ë Œë” êµì²´)
      ensureDataLoaded();
    })();
  </script>
</body>
</html>
